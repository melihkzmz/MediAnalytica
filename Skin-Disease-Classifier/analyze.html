<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hastalık Analiz Sistemi - MediAnalytica</title>
    
    <!-- Bootstrap & Icons -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* ============================================================================
           DESIGN SYSTEM - CSS Variables
           ============================================================================ */
        :root {
            /* Color Palette */
            --primary: #667eea;
            --primary-dark: #764ba2;
            --secondary: #f5576c;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --pink: #f093fb;
            --teal: #4ecdc4;
            --coral: #ff6b6b;
            --yellow: #ffd93d;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;

            /* Typography Scale */
            --font-size-xs: 0.75rem;    /* 12px */
            --font-size-sm: 0.875rem;    /* 14px */
            --font-size-base: 1rem;      /* 16px */
            --font-size-lg: 1.125rem;    /* 18px */
            --font-size-xl: 1.25rem;     /* 20px */
            --font-size-2xl: 1.5rem;     /* 24px */
            --font-size-3xl: 1.875rem;   /* 30px */
            --font-size-4xl: 2.25rem;    /* 36px */
            
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Spacing Scale */
            --spacing-1: 0.25rem;   /* 4px */
            --spacing-2: 0.5rem;    /* 8px */
            --spacing-3: 0.75rem;   /* 12px */
            --spacing-4: 1rem;      /* 16px */
            --spacing-5: 1.25rem;   /* 20px */
            --spacing-6: 1.5rem;    /* 24px */
            --spacing-8: 2rem;      /* 32px */
            --spacing-10: 2.5rem;   /* 40px */
            --spacing-12: 3rem;     /* 48px */
            --spacing-16: 4rem;     /* 64px */

            /* Border Radius */
            --radius-sm: 0.25rem;   /* 4px */
            --radius-md: 0.5rem;    /* 8px */
            --radius-lg: 0.75rem;   /* 12px */
            --radius-xl: 1rem;      /* 16px */
            --radius-2xl: 1.25rem;  /* 20px */
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-normal);
            background: #fff;
            background-attachment: fixed;
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            padding-top: 70px;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            color: var(--gray-800);
            position: relative;
            overflow-x: hidden;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255,255,255,0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* Mobile-First: Base styles (mobile) */
        .welcome-card,
        .analysis-card,
        .stats-card,
        .history-card {
            padding: 15px; /* Mobile: küçük padding */
            margin-bottom: 20px;
        }

        .content-with-sidebar {
            margin-left: 0; /* Mobile: sidebar yok */
            padding: 20px; /* Mobile: küçük padding */
            position: relative;
            z-index: 1;
        }

        .main-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Touch targets - Mobile */
        button,
        .clickable,
        .sidebar-item,
        .profile-menu-item {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 20px;
        }

        .analyze-button {
            min-height: 50px;
            padding: 15px 30px;
        }

        /* Sidebar - Mobile Drawer Pattern */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px; /* Mobile: küçük header */
            width: 280px;
            height: calc(100vh - 60px);
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
            z-index: 999;
            overflow-y: auto;
            transform: translateX(-100%); /* Mobile: gizli başla */
            transition: transform 0.3s ease;
        }

        .sidebar.open {
            transform: translateX(0); /* Mobile: açık */
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        /* Tablet ve üzeri */
        @media (min-width: 768px) {
            body {
                padding-top: 80px;
            }

            .welcome-card,
            .analysis-card,
            .stats-card,
            .history-card {
                padding: 30px; /* Tablet+: büyük padding */
            }

            .content-with-sidebar {
                margin-left: 250px; /* Tablet+: sidebar görünür */
                padding: 30px;
            }

            .sidebar {
                top: 80px;
                height: calc(100vh - 80px);
                transform: translateX(0); /* Tablet+: her zaman görünür */
            }

            .sidebar-overlay {
                display: none !important; /* Tablet+: overlay yok */
            }

            button,
            .clickable {
                min-height: auto; /* Tablet+: normal boyut */
                min-width: auto;
            }
        }

        /* Desktop */
        @media (min-width: 1024px) {
            .main-container {
                max-width: 1200px;
            }

            .welcome-card,
            .analysis-card {
                padding: 40px; /* Desktop: daha büyük padding */
            }
        }

        /* Header Styles */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .navbar-brand {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-2xl);
            color: var(--primary) !important;
        }

        .profile-dropdown {
            position: relative;
        }

        .profile-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            border: none;
            padding: var(--spacing-2) var(--spacing-5);
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            transition: transform var(--transition-fast), box-shadow var(--transition-base);
        }

        .profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 250px;
            margin-top: 10px;
            display: none;
            overflow: hidden;
        }

        .profile-menu.show {
            display: block;
        }

        .profile-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .profile-info {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #333;
        }

        .profile-info-item:last-child {
            margin-bottom: 0;
        }

        .profile-menu-item {
            padding: var(--spacing-4) var(--spacing-5);
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            color: var(--gray-800);
        }

        .profile-menu-item:hover {
            background: var(--gray-100);
            transform: translateX(4px);
        }

        .profile-menu-item.logout {
            color: var(--danger);
            border-top: 1px solid var(--gray-200);
        }

        .profile-menu-item.logout:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        /* Sidebar Navigation - Mobile-first */

        .sidebar-item {
            padding: var(--spacing-4) var(--spacing-6);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
            color: var(--gray-800);
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: var(--gray-100);
            border-left-color: var(--primary);
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: var(--font-weight-semibold);
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
        }

        .content-with-sidebar {
            margin-left: 250px;
            padding: 30px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 998;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* Swipe gesture için touch events */
        .sidebar {
            touch-action: pan-y;
        }

        /* Share Modal */
        .share-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
        }

        .share-modal.show {
            display: block !important;
        }


        .feedback-star {
            transition: transform var(--transition-fast);
        }

        .feedback-star:hover {
            transform: scale(1.2);
        }

        .feedback-star.active {
            color: #ffc107 !important;
        }

        .feedback-star.active i {
            font-weight: 900;
        }

        .share-link-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .welcome-card,
        .analysis-card,
        .stats-card,
        .history-card {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--spacing-8);
            margin-bottom: var(--spacing-8);
            box-shadow: var(--shadow-xl);
            transition: transform var(--transition-base), box-shadow var(--transition-base);
        }

        .welcome-card:hover,
        .analysis-card:hover,
        .stats-card:hover,
        .history-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .welcome-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--gray-800);
            margin-bottom: var(--spacing-2);
        }

        .welcome-subtitle {
            color: var(--gray-600);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-normal);
        }

        /* Analysis card already defined above with other cards */

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: var(--spacing-2);
            color: var(--gray-800);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-lg);
        }

        select, input[type="file"] {
            width: 100%;
            padding: var(--spacing-3);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            transition: border-color var(--transition-base), box-shadow var(--transition-base);
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .image-preview {
            margin-top: 20px;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .image-preview img.show {
            display: inline-block;
        }

        .analyze-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .analyze-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-item {
            background: var(--white);
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-2);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform var(--transition-base), box-shadow var(--transition-base);
            animation: fadeIn 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .result-item:first-child {
            border-left-color: var(--secondary);
            font-weight: var(--font-weight-semibold);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-label {
            color: var(--gray-800);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
        }

        .result-probability {
            color: var(--primary);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-xl);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            max-width: 500px;
            opacity: 0;
            transform: translateX(400px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toast-success {
            border-left: 4px solid #28a745;
        }

        .toast-error {
            border-left: 4px solid #dc3545;
        }

        .toast-warning {
            border-left: 4px solid #ffc107;
        }

        .toast-info {
            border-left: 4px solid #17a2b8;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 64px;
            color: #ccc;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            margin-bottom: 20px;
        }

        /* Progress Bar */
        .loading-progress {
            text-align: center;
            padding: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Focus Indicators */
        *:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        /* Remove focus outline for checkboxes in all states */
        input[type="checkbox"]:focus,
        input[type="checkbox"]:focus-visible {
            outline: none;
            box-shadow: none;
        }

        /* Dark Mode */
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-card: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
        }

        [data-theme="dark"] body {
            background: var(--bg-primary);
        }

        [data-theme="dark"] .welcome-card,
        [data-theme="dark"] .analysis-card,
        [data-theme="dark"] .stats-card,
        [data-theme="dark"] .history-card,
        [data-theme="dark"] .sidebar,
        [data-theme="dark"] .profile-menu,
        [data-theme="dark"] .share-modal {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        [data-theme="dark"] label,
        [data-theme="dark"] .welcome-title,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .welcome-subtitle,
        [data-theme="dark"] p {
            color: var(--text-secondary);
        }

        [data-theme="dark"] select,
        [data-theme="dark"] input,
        [data-theme="dark"] .share-link-input {
            background: #2a2a2a;
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .sidebar-item:hover,
        [data-theme="dark"] .profile-menu-item:hover {
            background: #2a2a2a;
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        @media (prefers-color-scheme: dark) {
            /* Sistem dark mode tercihini otomatik algıla */
            body:not([data-theme="light"]) {
                --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                --bg-card: #1e1e1e;
                --text-primary: #ffffff;
                --text-secondary: #b0b0b0;
                --border-color: #333333;
            }
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-md);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: var(--spacing-2);
        }

        .skeleton-title {
            height: 2rem;
            width: 60%;
            margin-bottom: var(--spacing-4);
        }

        .skeleton-card {
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }

        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple:active::after {
            width: 300px;
            height: 300px;
        }

        .model-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .model-status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .model-status.ready {
            background: #d4edda;
            color: #155724;
        }

        .model-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .align-items-center {
            align-items: center;
        }

        .text-right {
            text-align: right;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -10px;
        }

        .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .col-md-3 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 20px 10px;
            }
            
            .welcome-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
<script>
  (function(){
    const token = localStorage.getItem("firebase_id_token");
    if(!token){
      window.location.replace("templates/login.html");
    }
  })();
</script>

    <!-- Header -->
    <nav class="navbar navbar-custom">
        <div class="container-fluid">
            <div class="d-flex align-items-center w-100 justify-content-between">
                <button class="btn btn-link d-md-none" onclick="toggleSidebar()" style="margin-right: 15px;">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#">
                    <i class="fas fa-stethoscope"></i> MediAnalytica
                </a>
                
                <div class="profile-dropdown">
                    <button class="profile-btn" id="profileBtn">
                        <img id="profileBtnPhoto" src="" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; display: none; border: 2px solid rgba(255,255,255,0.3);">
                        <span id="userName">Kullanıcı</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <img id="profileMenuPhoto" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                            </div>
                            <div id="profileEmail">Yükleniyor...</div>
                        </div>
                        <div class="profile-info">
                            <div class="profile-info-item">
                                <i class="fas fa-calendar"></i>
                                <span id="profileJoinDate">Üyelik: -</span>
                            </div>
                        </div>
                        <div class="profile-menu-item" id="profileSettingsBtn">
                            <i class="fas fa-cog"></i>
                            <span>Profil Ayarları</span>
                        </div>
                        <div class="profile-menu-item" id="favoritesBtn">
                            <i class="fas fa-heart"></i>
                            <span>Favorilerim</span>
                        </div>
                        <div class="profile-menu-item logout" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Çıkış Yap</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-item active" onclick="showSection('dashboard', this)">
            <i class="fas fa-home"></i>
            <span>Ana Menü</span>
        </div>
        <div class="sidebar-item" onclick="showSection('analyze', this)">
            <i class="fas fa-microscope"></i>
            <span>Analiz Yap</span>
        </div>
        <div class="sidebar-item" onclick="showSection('history', this)">
            <i class="fas fa-history"></i>
            <span>Analiz Geçmişi</span>
        </div>
        <div class="sidebar-item" onclick="showSection('favorites', this)">
            <i class="fas fa-heart"></i>
            <span>Favoriler</span>
        </div>
        <div class="sidebar-item" onclick="showSection('stats', this)">
            <i class="fas fa-chart-bar"></i>
            <span>İstatistikler</span>
        </div>
        <div class="sidebar-item" onclick="showSection('appointment', this)">
            <i class="fas fa-video"></i>
            <span>Randevu Talep</span>
        </div>
        <hr style="margin: var(--spacing-4) 0; border-color: var(--gray-200);">
        <div class="sidebar-item" onclick="showSection('help', this)">
            <i class="fas fa-question-circle"></i>
            <span>Yardım</span>
        </div>
        <div class="sidebar-item" onclick="showSection('contact', this)">
            <i class="fas fa-envelope"></i>
            <span>İletişim</span>
        </div>
        <div class="sidebar-item" onclick="showSection('about', this)">
            <i class="fas fa-building"></i>
            <span>Hakkımızda</span>
        </div>
        <div class="sidebar-item" onclick="showSection('feedback', this)">
            <i class="fas fa-comment-dots"></i>
            <span>Geri Bildirim</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-with-sidebar">
    <div class="main-container" id="main-content-container">
        <!-- Dashboard Section -->
        <div id="dashboard-section" style="display: block;">
            <!-- Welcome Hero Card -->
            <div class="welcome-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="text-center">
                    <h1 class="welcome-title" style="color: white; font-size: 3rem; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                        <i class="fas fa-heartbeat" style="color: #ff6b6b; animation: heartbeat 1.5s ease-in-out infinite;"></i> MediAnalytica
                    </h1>
                    <p class="welcome-subtitle" style="color: rgba(255,255,255,0.95); font-size: 1.3rem; margin-bottom: 30px; line-height: 1.8;">
                        Sağlığınız için yapay zeka destekli çözümler sunuyoruz
                    </p>
                    <div class="d-flex justify-content-center flex-wrap" style="gap: 20px;">
                        <button class="btn btn-light btn-lg" onclick="showSection('analyze', null)" style="padding: 15px 30px; font-size: 1.1rem; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                            <i class="fas fa-microscope"></i> Analiz Yap
                    </button>
                        <button class="btn btn-outline-light btn-lg" onclick="showHistory()" style="padding: 15px 30px; font-size: 1.1rem; border-radius: 50px; border-width: 2px;">
                            <i class="fas fa-history"></i> Geçmişim
                    </button>
                    </div>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="row" style="margin-top: 30px;">
                <div class="col-md-4 mb-4">
                    <div class="welcome-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; height: 100%; transition: transform 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-10px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="text-center">
                            <i class="fas fa-brain" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.9;"></i>
                            <h3 style="color: white; margin-bottom: 15px;">Yapay Zeka Destekli</h3>
                            <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">
                                Gelişmiş makine öğrenmesi algoritmaları ile yüksek doğruluk oranında hastalık tespiti
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="welcome-card" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; border: none; height: 100%; transition: transform 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-10px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="text-center">
                            <i class="fas fa-user-md" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.9;"></i>
                            <h3 style="color: white; margin-bottom: 15px;">Uzman Doktor Desteği</h3>
                            <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">
                                Görüntülü görüşme ile uzman doktorlardan anında danışmanlık alabilirsiniz
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="welcome-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; height: 100%; transition: transform 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-10px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="text-center">
                            <i class="fas fa-shield-alt" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.9;"></i>
                            <h3 style="color: white; margin-bottom: 15px;">Güvenli ve Hızlı</h3>
                            <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">
                                Verileriniz güvende, sonuçlarınız saniyeler içinde hazır
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div class="welcome-card" style="background: white; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 40px;">
                <h2 style="background: linear-gradient(135deg, #667eea 0%, #4ecdc4 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 40px; text-align: center; font-size: 2.5rem; font-weight: 800;">
                    <i class="fas fa-cogs"></i> Nasıl Çalışır?
                </h2>
                <div class="row">
                    <div class="col-md-3 text-center mb-4">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-list-alt" style="color: white; font-size: 2.5rem;"></i>
                        </div>
                        <h4 style="color: #667eea; margin-bottom: 15px; font-weight: 700; font-size: 1.3rem;">1. Hastalık Türü Seç</h4>
                        <p style="color: var(--gray-600); line-height: 1.8; font-size: 1rem;">Kemik, Deri, Akciğer veya Göz hastalıklarından birini seçin. Her hastalık türü için özel olarak eğitilmiş yapay zeka modelleri kullanılır.</p>
                    </div>
                    <div class="col-md-3 text-center mb-4">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-upload" style="color: white; font-size: 2.5rem;"></i>
                        </div>
                        <h4 style="color: #f5576c; margin-bottom: 15px; font-weight: 700; font-size: 1.3rem;">2. Görüntü Yükle</h4>
                        <p style="color: var(--gray-600); line-height: 1.8; font-size: 1rem;">Yüksek çözünürlüklü görüntü yükleyin. Görüntü otomatik olarak optimize edilir ve backend'e iletilir. JPEG ve PNG formatları desteklenir.</p>
                    </div>
                    <div class="col-md-3 text-center mb-4">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-brain" style="color: white; font-size: 2.5rem;"></i>
                        </div>
                        <h4 style="color: #4ecdc4; margin-bottom: 15px; font-weight: 700; font-size: 1.3rem;">3. Görüntü İşleme & Sınıflandırma</h4>
                        <p style="color: var(--gray-600); line-height: 1.8; font-size: 1rem;">Yapay zeka modeli görüntüyü analiz eder. Derin öğrenme algoritmaları ile hastalık tespiti yapılır ve olasılık skorları hesaplanır.</p>
                    </div>
                    <div class="col-md-3 text-center mb-4">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #ffd93d 0%, #f6b93b 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; box-shadow: 0 8px 25px rgba(255, 217, 61, 0.4); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-chart-line" style="color: white; font-size: 2.5rem;"></i>
                        </div>
                        <h4 style="color: #f6b93b; margin-bottom: 15px; font-weight: 700; font-size: 1.3rem;">4. Sonuçların Gösterilmesi</h4>
                        <p style="color: var(--gray-600); line-height: 1.8; font-size: 1rem;">Detaylı analiz sonuçları, olasılık skorları ve görselleştirmelerle birlikte anında görüntülenir. Sonuçlarınızı kaydedebilir ve paylaşabilirsiniz.</p>
                    </div>
                </div>
            </div>

            <!-- Technologies Used -->
            <div class="welcome-card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(78, 205, 196, 0.05) 100%); border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 40px; margin-top: 30px;">
                <h2 style="background: linear-gradient(135deg, #667eea 0%, #4ecdc4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 40px; text-align: center; font-size: 2.5rem; font-weight: 800;">
                    <i class="fas fa-code"></i> Kullanılan Teknolojiler
                </h2>
                <p style="text-align: center; color: var(--gray-600); font-size: 1.1rem; margin-bottom: 40px; line-height: 1.8;">
                    Bu proje, modern web teknolojileri ve yapay zeka kütüphaneleri kullanılarak geliştirilmiştir. 
                    Dinamik ve interaktif bir web sitesi oluşturmak için aşağıdaki teknolojiler kullanılmıştır.
                </p>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; height: 100%; transition: transform 0.3s; border-top: 4px solid #667eea;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);">
                                <i class="fab fa-python" style="color: white; font-size: 2.5rem;"></i>
                            </div>
                            <h4 style="color: #667eea; margin-bottom: 15px; font-weight: 700;">Backend</h4>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;"><strong>Python</strong></p>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;">Flask API Framework</p>
                            <p style="color: var(--gray-600); line-height: 1.8;">RESTful API Servisleri</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; height: 100%; transition: transform 0.3s; border-top: 4px solid #4ecdc4;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);">
                                <i class="fas fa-brain" style="color: white; font-size: 2.5rem;"></i>
                            </div>
                            <h4 style="color: #4ecdc4; margin-bottom: 15px; font-weight: 700;">Yapay Zeka</h4>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;"><strong>TensorFlow & Keras</strong></p>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;">Derin Öğrenme Modelleri</p>
                            <p style="color: var(--gray-600); line-height: 1.8;">scikit-learn</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; height: 100%; transition: transform 0.3s; border-top: 4px solid #f093fb;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(240, 147, 251, 0.3);">
                                <i class="fab fa-html5" style="color: white; font-size: 2.5rem;"></i>
                            </div>
                            <h4 style="color: #f5576c; margin-bottom: 15px; font-weight: 700;">Frontend</h4>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;"><strong>HTML5, CSS3, JavaScript</strong></p>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;">Bootstrap Framework</p>
                            <p style="color: var(--gray-600); line-height: 1.8;">TensorFlow.js</p>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-top: 20px;">
                    <div class="col-md-6 mb-4">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; height: 100%; transition: transform 0.3s; border-top: 4px solid #ff6b6b;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);">
                                <i class="fab fa-google" style="color: white; font-size: 2.5rem;"></i>
                            </div>
                            <h4 style="color: #ff6b6b; margin-bottom: 15px; font-weight: 700;">Cloud & Database</h4>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;"><strong>Firebase</strong></p>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;">Authentication & Firestore</p>
                            <p style="color: var(--gray-600); line-height: 1.8;">Cloud Storage</p>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; height: 100%; transition: transform 0.3s; border-top: 4px solid #ffd93d;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #ffd93d 0%, #f6b93b 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(255, 217, 61, 0.3);">
                                <i class="fab fa-github" style="color: white; font-size: 2.5rem;"></i>
                            </div>
                            <h4 style="color: #f6b93b; margin-bottom: 15px; font-weight: 700;">Version Control</h4>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;"><strong>Git & GitHub</strong></p>
                            <p style="color: var(--gray-600); line-height: 1.8; margin-bottom: 10px;">Code Repository</p>
                            <p style="color: var(--gray-600); line-height: 1.8;">Collaborative Development</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="row" style="margin-top: 30px;">
                <div class="col-md-12">
                    <div class="welcome-card" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); border: none; backdrop-filter: blur(10px);">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div style="font-size: 3rem; color: #667eea; font-weight: bold; margin-bottom: 10px;">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4 style="color: var(--gray-800);">Binlerce Kullanıcı</h4>
                                <p style="color: var(--gray-600);">Sağlığına önem veren kullanıcılarımız</p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div style="font-size: 3rem; color: #f093fb; font-weight: bold; margin-bottom: 10px;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h4 style="color: var(--gray-800);">Yüksek Doğruluk</h4>
                                <p style="color: var(--gray-600);">%95+ doğruluk oranı ile analiz</p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div style="font-size: 3rem; color: #4ecdc4; font-weight: bold; margin-bottom: 10px;">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h4 style="color: var(--gray-800);">Hızlı Sonuç</h4>
                                <p style="color: var(--gray-600);">Saniyeler içinde analiz sonucu</p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div style="font-size: 3rem; color: #ff6b6b; font-weight: bold; margin-bottom: 10px;">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <h4 style="color: var(--gray-800);">7/24 Destek</h4>
                                <p style="color: var(--gray-600);">Her zaman yanınızdayız</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Card (Hidden by default) -->
        <div class="welcome-card" id="stats-card" style="display: none;">
            <h2><i class="fas fa-chart-bar"></i> İstatistikleriniz</h2>
            <div id="stats-content">Yükleniyor...</div>
        </div>

        <!-- History Card (Hidden by default) -->
        <div class="welcome-card" id="history-card" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 style="margin: 0;"><i class="fas fa-history"></i> Analiz Geçmişiniz</h2>
                <div>
                    <select id="history-filter-type" class="form-control" style="display: inline-block; width: auto; margin-right: 10px;" onchange="loadHistory()">
                        <option value="">Tüm Hastalıklar</option>
                        <option value="bone"><i class="fas fa-bone"></i> Kemik</option>
                        <option value="skin"><i class="fas fa-hand-sparkles"></i> Deri</option>
                        <option value="lung"><i class="fas fa-lungs"></i> Akciğer</option>
                        <option value="eye"><i class="fas fa-eye"></i> Göz</option>
                    </select>
                    <input type="date" id="history-filter-date" class="form-control" style="display: inline-block; width: auto;" onchange="loadHistory()">
                </div>
            </div>
            <div id="history-content">Yükleniyor...</div>
        </div>

        <!-- Favorites Card (Hidden by default) -->
        <div class="welcome-card" id="favorites-card" style="display: none;">
            <h2><i class="fas fa-heart"></i> Favorileriniz</h2>
            <div id="favorites-content">Yükleniyor...</div>
        </div>

        <!-- Appointments Card (Hidden by default) -->
        <div class="welcome-card" id="appointments-card" style="display: none;">
            <h2><i class="fas fa-calendar-check"></i> Randevularım</h2>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary btn-sm" onclick="showSection('appointment', null)">
                    <i class="fas fa-plus"></i> Yeni Randevu Talep Et
                </button>
                <select id="appointment-filter-status" class="form-control" style="display: inline-block; width: auto; margin-left: 10px;" onchange="loadAppointments()">
                    <option value="">Tüm Durumlar</option>
                    <option value="pending">Beklemede</option>
                    <option value="approved">Onaylandı</option>
                    <option value="rejected">Reddedildi</option>
                    <option value="completed">Tamamlandı</option>
                </select>
            </div>
            <div id="appointments-content">Yükleniyor...</div>
        </div>

        <!-- Appointment Request Section -->
        <div class="welcome-card" id="appointment-section" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.15) 0%, rgba(102, 126, 234, 0.15) 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #4ecdc4;">
                <h2 style="background: linear-gradient(135deg, #4ecdc4 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-size: 2rem;"><i class="fas fa-calendar-plus"></i> Randevu Talep Et</h2>
                <p style="color: var(--gray-600); font-size: 1.1rem;">Uzman doktorlarımızdan görüntülü görüşme ile randevu alabilirsiniz. Randevu talebiniz doktor onayından sonra size bildirilecektir.</p>
            </div>
            <form id="appointmentRequestForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: var(--gray-800);"><i class="fas fa-calendar" style="color: #4ecdc4; margin-right: 8px;"></i> Randevu Tarihi</label>
                            <input type="date" class="form-control" id="appointmentRequestDate" required min="" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: var(--gray-800);"><i class="fas fa-clock" style="color: #f5576c; margin-right: 8px;"></i> Randevu Saati</label>
                            <select class="form-control" id="appointmentRequestTime" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; color: var(--gray-800);">
                                <option value="" style="color: var(--gray-500);">Saat seçiniz</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: var(--gray-800);"><i class="fas fa-user-md" style="color: #667eea; margin-right: 8px;"></i> Doktor Türü</label>
                    <select class="form-control" id="appointmentRequestDoctorType" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; color: var(--gray-800);">
                        <option value="" style="color: var(--gray-500);">Uzmanlık seçiniz</option>
                        <option value="dermatolog">Dermatolog</option>
                        <option value="ortopedist">Ortopedist</option>
                        <option value="gogus-hast">Göğüs Hastalıkları Uzmanı</option>
                        <option value="goz-hast">Göz Hastalıkları Uzmanı</option>
                        <option value="genel-cerrahi">Genel Cerrahi</option>
                        <option value="ic-hastaliklari">İç Hastalıkları</option>
                        <option value="noroloji">Nöroloji</option>
                        <option value="kardiyoloji">Kardiyoloji</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: var(--gray-800);"><i class="fas fa-comment-medical" style="color: #f093fb; margin-right: 8px;"></i> Şikayet/Konu</label>
                    <textarea class="form-control" id="appointmentRequestReason" rows="4" placeholder="Randevu nedeni, şikayetleriniz veya sorularınız..." required maxlength="500" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; resize: vertical;"></textarea>
                    <small style="color: var(--gray-600);">Maksimum 500 karakter</small>
                </div>
                <div style="margin-top: 25px;">
                    <button type="submit" class="btn btn-primary btn-lg" style="padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; background: linear-gradient(135deg, #4ecdc4 0%, #667eea 100%); border: none; box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);">
                        <i class="fas fa-calendar-check"></i> Randevu Talep Et
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="showSection('appointments', null)" style="padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; margin-left: 10px;">
                        <i class="fas fa-arrow-left"></i> Randevularıma Dön
                        </button>
                    </div>
            </form>
            <div id="appointment-request-result" style="margin-top: 25px;"></div>
        </div>

        <!-- Active Appointments Section (Onaylanan Randevular - Hızlı Erişim) -->
        <div class="welcome-card" id="active-appointments-section" style="display: none; margin-top: 30px;">
            <div style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(78, 205, 196, 0.15) 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #28a745;">
                <h2 style="background: linear-gradient(135deg, #28a745 0%, #4ecdc4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-size: 2rem;">
                    <i class="fas fa-video"></i> Aktif Randevularım
                </h2>
                <p style="color: var(--gray-600); font-size: 1.1rem;">Onaylanan randevularınıza görüntülü görüşme için buradan katılabilirsiniz.</p>
            </div>
            <div id="active-appointments-content">
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Yükleniyor...</span>
                    </div>
                    <p style="margin-top: 15px; color: var(--gray-600);">Randevular yükleniyor...</p>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="welcome-card" id="help-section" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.15) 0%, rgba(240, 147, 251, 0.15) 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #ff6b6b;">
                <h2 style="background: linear-gradient(135deg, #ff6b6b 0%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-size: 2rem;"><i class="fas fa-question-circle"></i> Yardım Merkezi</h2>
                <p style="color: var(--gray-600); font-size: 1.1rem;">Sık sorulan sorular ve kullanım kılavuzu</p>
                        </div>
            
            <div style="margin-bottom: 40px;">
                <h3 style="background: linear-gradient(135deg, #667eea 0%, #4ecdc4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 20px; font-size: 1.8rem;"><i class="fas fa-info-circle"></i> Sık Sorulan Sorular</h3>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 100%; border-left: 4px solid #667eea;">
                            <h5 style="color: #667eea; margin-bottom: 15px; font-weight: 700;"><i class="fas fa-microscope"></i> Analiz Nasıl Yapılır?</h5>
                            <p style="color: var(--gray-600); line-height: 1.8;">
                                Sol menüden <strong>"Analiz Yap"</strong> bölümüne gidin, hastalık türünü seçin (Kemik, Deri, Akciğer veya Göz), görüntünüzü yükleyin ve <strong>"Analiz Et"</strong> butonuna tıklayın. Sonuçlar birkaç saniye içinde hazır olacaktır.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 100%; border-left: 4px solid #f093fb;">
                            <h5 style="color: #f5576c; margin-bottom: 15px; font-weight: 700;"><i class="fas fa-history"></i> Analiz Geçmişime Nasıl Ulaşırım?</h5>
                            <p style="color: var(--gray-600); line-height: 1.8;">
                                Sol menüden <strong>"Analiz Geçmişi"</strong> bölümüne tıklayarak tüm geçmiş analizlerinizi görüntüleyebilir, filtreleyebilir ve detaylarını inceleyebilirsiniz.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 100%; border-left: 4px solid #4ecdc4;">
                            <h5 style="color: #4ecdc4; margin-bottom: 15px; font-weight: 700;"><i class="fas fa-heart"></i> Favorilere Nasıl Eklersiniz?</h5>
                            <p style="color: var(--gray-600); line-height: 1.8;">
                                Analiz sonuçlarında <strong>"Favorilere Ekle"</strong> butonuna tıklayarak önemli analizlerinizi kaydedebilirsiniz. Favorilerinize <strong>"Favoriler"</strong> menüsünden ulaşabilirsiniz.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 100%; border-left: 4px solid #ff6b6b;">
                            <h5 style="color: #ff6b6b; margin-bottom: 15px; font-weight: 700;"><i class="fas fa-video"></i> Randevu Nasıl Alırım?</h5>
                            <p style="color: var(--gray-600); line-height: 1.8;">
                                <strong>"Randevu Talep"</strong> bölümünden tarih, saat ve doktor türünü seçerek randevu talebi oluşturabilirsiniz. Doktor onayından sonra görüntülü görüşmeye katılabilirsiniz.
                            </p>
                    </div>
                </div>
            </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.15) 0%, rgba(102, 126, 234, 0.15) 100%); padding: 25px; border-radius: 15px; margin-top: 30px; border-left: 5px solid #4ecdc4;">
                <h4 style="color: #4ecdc4; margin-bottom: 15px; font-weight: 700;"><i class="fas fa-envelope"></i> Daha Fazla Yardım?</h4>
                <p style="color: var(--gray-600); margin-bottom: 15px;">Sorunuz mu var? Bize ulaşın:</p>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <a href="#" onclick="showSection('contact', null); return false;" style="color: #667eea; font-weight: 600; text-decoration: none; font-size: 1.05rem;">
                        <i class="fas fa-phone"></i> İletişim Sayfası
                    </a>
                    <a href="mailto:MediAnalytica@gmail.com" style="color: #f5576c; font-weight: 600; text-decoration: none; font-size: 1.05rem;">
                        <i class="fas fa-envelope"></i> MediAnalytica@gmail.com
                    </a>
                </div>
            </div>
        </div>

        <!-- Contact Section -->
        <div class="welcome-card" id="contact-section" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(78, 205, 196, 0.15) 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #667eea;">
                <h2 style="background: linear-gradient(135deg, #667eea 0%, #4ecdc4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-size: 2rem;"><i class="fas fa-envelope"></i> İletişim</h2>
                <p style="color: var(--gray-600); font-size: 1.1rem;">Bize ulaşın, sorularınızı sorun, önerilerinizi paylaşın</p>
            </div>
            
            <div class="row" style="margin-bottom: 30px;">
                <div class="col-md-6 mb-4">
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 30px; border-radius: 15px; height: 100%; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-map-marker-alt" style="color: white; font-size: 2rem;"></i>
                        </div>
                        <h4 style="color: #667eea; margin-bottom: 15px; font-weight: 700;">Adres</h4>
                        <p style="color: var(--gray-600); line-height: 1.8; font-size: 1.05rem;">
                            Çankaya, Konutkent Mahallesi<br>
                            Vadi Caddesi No: 42/6<br>
                            Ankara, Türkiye
                        </p>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div style="background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.1) 100%); padding: 30px; border-radius: 15px; height: 100%; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(240, 147, 251, 0.3);">
                            <i class="fas fa-phone" style="color: white; font-size: 2rem;"></i>
                        </div>
                        <h4 style="color: #f5576c; margin-bottom: 15px; font-weight: 700;">Telefon</h4>
                        <p style="color: var(--gray-600); margin-bottom: 10px;">
                            <a href="tel:05301112233" style="color: #f5576c; font-size: 1.3rem; font-weight: 600; text-decoration: none;">0530 111 22 33</a>
                        </p>
                        <p style="color: var(--gray-600); font-size: 0.95rem;">Pazartesi - Cuma: 09:00 - 18:00</p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%); padding: 30px; border-radius: 15px; height: 100%; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(78, 205, 196, 0.3);">
                            <i class="fas fa-envelope" style="color: white; font-size: 2rem;"></i>
                        </div>
                        <h4 style="color: #4ecdc4; margin-bottom: 15px; font-weight: 700;">E-posta</h4>
                        <p style="color: var(--gray-600); margin-bottom: 10px;">
                            <a href="mailto:MediAnalytica@gmail.com" style="color: #4ecdc4; font-size: 1.1rem; font-weight: 600; text-decoration: none;">MediAnalytica@gmail.com</a>
                        </p>
                        <p style="color: var(--gray-600); font-size: 0.95rem;">7/24 e-posta desteği</p>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(238, 90, 111, 0.1) 100%); padding: 30px; border-radius: 15px; height: 100%; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);">
                            <i class="fas fa-building" style="color: white; font-size: 2rem;"></i>
                        </div>
                        <h4 style="color: #ff6b6b; margin-bottom: 15px; font-weight: 700;">Şirket</h4>
                        <p style="color: var(--gray-600); line-height: 1.8; font-size: 1.05rem;">
                            MediAnalytica<br>
                            Sağlık Teknolojileri A.Ş.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div class="welcome-card" id="about-section" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(240, 147, 251, 0.15) 0%, rgba(102, 126, 234, 0.15) 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #f093fb;">
                <h2 style="background: linear-gradient(135deg, #f093fb 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-size: 2rem;"><i class="fas fa-building"></i> Hakkımızda</h2>
                <p style="color: var(--gray-600); font-size: 1.1rem;">MediAnalytica'nın hikayesi ve ekibi</p>
            </div>
            
            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid #f093fb;">
                <h3 style="background: linear-gradient(135deg, #f093fb 0%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 20px; font-size: 1.8rem;"><i class="fas fa-lightbulb"></i> Bizim Hikayemiz</h3>
                <p style="color: var(--gray-600); line-height: 1.8; font-size: 1.05rem; margin-bottom: 15px;">
                    <strong>MediAnalytica</strong>, 2025 yılında Ankara'da üç bilgisayar mühendisi tarafından kuruldu.
                </p>
                <p style="color: var(--gray-600); line-height: 1.8; font-size: 1.05rem;">
                    Sağlık alanında, yenilikçi ve yapay zeka destekli çözümler üretmek ve hastaların hayatını kolaylaştırmak amacıyla yola çıktık.
                    Ankara merkezli girişimimizle; ülkemizin ve dünyanın ihtiyaç duyduğu teknolojik eksikliği fark edip, fark yaratan bir sağlık deneyimi sunuyoruz.
                </p>
            </div>

            <div style="margin-bottom: 30px;">
                <h3 style="background: linear-gradient(135deg, #667eea 0%, #4ecdc4 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 25px; text-align: center; font-size: 2rem;"><i class="fas fa-users"></i> Kurucu Ekip</h3>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-user" style="color: white; font-size: 3rem;"></i>
                            </div>
                            <h4 style="color: #667eea; margin-bottom: 10px; font-weight: 700;">Efe Cengiz Köse</h4>
                            <p style="color: var(--gray-600); margin-bottom: 5px; font-weight: 600;">Bilgisayar Mühendisi</p>
                            <p style="color: var(--gray-500); font-size: 0.9rem;">Kurucu & CEO</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(240, 147, 251, 0.3);">
                                <i class="fas fa-user" style="color: white; font-size: 3rem;"></i>
                            </div>
                            <h4 style="color: #f5576c; margin-bottom: 10px; font-weight: 700;">Melih Kızmaz</h4>
                            <p style="color: var(--gray-600); margin-bottom: 5px; font-weight: 600;">Bilgisayar Mühendisi</p>
                            <p style="color: var(--gray-500); font-size: 0.9rem;">Kurucu & CTO</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 5px 20px rgba(78, 205, 196, 0.3);">
                                <i class="fas fa-user" style="color: white; font-size: 3rem;"></i>
                            </div>
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-weight: 700;">Dilara Aydın</h4>
                            <p style="color: var(--gray-600); margin-bottom: 5px; font-weight: 600;">Bilgisayar Mühendisi</p>
                            <p style="color: var(--gray-500); font-size: 0.9rem;">Kurucu & Lead Developer</p>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 160, 141, 0.1) 100%); padding: 25px; border-radius: 15px;">
                <h4 style="color: #667eea; margin-bottom: 20px; font-weight: 700; font-size: 1.5rem;"><i class="fas fa-map-marker-alt"></i> İletişim Bilgileri</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <p style="color: var(--gray-600); margin-bottom: 5px;"><strong>Adres:</strong></p>
                        <p style="color: var(--gray-800);">Çankaya, Konutkent Mahallesi<br>Vadi Caddesi No: 42/6<br>Ankara, Türkiye</p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <p style="color: var(--gray-600); margin-bottom: 5px;"><strong>Telefon:</strong></p>
                        <p style="color: var(--gray-800);"><a href="tel:05301112233" style="color: #f5576c; font-weight: 600; text-decoration: none;">0530 111 22 33</a></p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <p style="color: var(--gray-600); margin-bottom: 5px;"><strong>E-posta:</strong></p>
                        <p style="color: var(--gray-800);"><a href="mailto:MediAnalytica@gmail.com" style="color: #4ecdc4; font-weight: 600; text-decoration: none;">MediAnalytica@gmail.com</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Section -->
        <div class="welcome-card" id="feedback-section" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.15) 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #ffc107;">
                <h2 style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; font-size: 2rem;"><i class="fas fa-comment-dots"></i> Geri Bildirim</h2>
                <p style="color: var(--gray-600); font-size: 1.1rem;">Görüşleriniz bizim için çok değerli! Lütfen deneyiminizi bizimle paylaşın.</p>
            </div>
            
            <form id="feedbackSectionForm">
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-weight: 600; color: var(--gray-800); font-size: 1.1rem; display: block; margin-bottom: 15px;"><i class="fas fa-star" style="color: #ffc107; margin-right: 8px;"></i> Değerlendirme</label>
                    <div style="text-align: center; font-size: 3rem; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border-radius: 15px;">
                        <i class="far fa-star feedback-star" data-rating="1" style="cursor: pointer; color: #ffc107; margin: 0 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></i>
                        <i class="far fa-star feedback-star" data-rating="2" style="cursor: pointer; color: #ffc107; margin: 0 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></i>
                        <i class="far fa-star feedback-star" data-rating="3" style="cursor: pointer; color: #ffc107; margin: 0 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></i>
                        <i class="far fa-star feedback-star" data-rating="4" style="cursor: pointer; color: #ffc107; margin: 0 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></i>
                        <i class="far fa-star feedback-star" data-rating="5" style="cursor: pointer; color: #ffc107; margin: 0 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'"></i>
                    </div>
                    <input type="hidden" id="feedbackSectionRating" value="0">
                    <p style="text-align: center; color: var(--gray-600); font-size: 0.9rem; margin-top: 10px;">Lütfen deneyiminizi değerlendirin (1-5 yıldız)</p>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="font-weight: 600; color: var(--gray-800); font-size: 1.1rem;"><i class="fas fa-comment" style="color: #f5576c; margin-right: 8px;"></i> Mesajınız</label>
                    <textarea class="form-control" id="feedbackSectionMessage" rows="6" placeholder="Geri bildiriminizi buraya yazın... Örneğin: Hangi özelliği beğendiniz? Neyi iyileştirebiliriz? Herhangi bir sorun yaşadınız mı?" required style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button type="submit" class="btn btn-primary btn-lg" style="padding: 15px 50px; font-size: 1.1rem; border-radius: 50px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border: none; box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);">
                        <i class="fas fa-paper-plane"></i> Gönder
                    </button>
                </div>
            </form>
            
            <div id="feedback-section-result" style="margin-top: 25px;"></div>
            
            <div style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.15) 0%, rgba(102, 126, 234, 0.15) 100%); padding: 25px; border-radius: 15px; margin-top: 30px; border-left: 5px solid #4ecdc4;">
                <h4 style="color: #4ecdc4; margin-bottom: 15px; font-weight: 700;"><i class="fas fa-info-circle"></i> Geri Bildirim Hakkında</h4>
                <p style="color: var(--gray-600); line-height: 1.8;">
                    Geri bildirimleriniz bizim için çok önemli! Her geri bildirim, platformumuzu daha iyi hale getirmemize yardımcı olur. 
                    Tüm geri bildirimlerinizi dikkatle inceliyor ve değerlendiriyoruz. Teşekkür ederiz!
                </p>
            </div>
        </div>


        <!-- Analysis Card -->
        <div class="analysis-card" style="display: none;">
        <div id="model-status" class="model-status loading">Model yükleniyor...</div>

        <div class="form-group" style="margin-bottom: 25px;">
                <label for="disease-type" style="font-weight: 600; color: var(--gray-800); margin-bottom: 10px; display: block; font-size: 1.1rem;">
                    <i class="fas fa-list" style="color: var(--primary); margin-right: 8px;"></i> Hastalık Türü Seçin
                </label>
                <select id="disease-type" aria-label="Hastalık türü seçin" style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; background: white; transition: all 0.3s; cursor: pointer;" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                <option value="">-- Hastalık türünü seçin --</option>
                    <option value="bone">🦴 Kemik Hastalıkları</option>
                    <option value="skin">✨ Deri Hastalıkları</option>
                    <option value="lung">🫁 Akciğer Hastalıkları</option>
                    <option value="eye">👁️ Göz Hastalıkları</option>
            </select>
        </div>

        <div id="skin-disease-warning" class="skin-disease-warning" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; color: #856404;">
            <div style="display: flex; align-items: flex-start;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 10px; margin-top: 2px; color: #ffc107; font-size: 1.2rem;"></i>
                <div>
                    <strong style="display: block; margin-bottom: 8px; color: #856404;">Önemli Bilgi:</strong>
                    <p style="margin: 0; line-height: 1.6; color: #856404;">
                        Lütfen tek bir deri lezyonunun dermatoskopik görüntüsünü yükleyin.<br>
                        Model yalnızca aşağıdaki lezyon türlerini analiz edebilir:
                    </p>
                    <ul style="margin: 8px 0 0 20px; padding: 0; color: #856404;">
                        <li>Melanom (MEL)</li>
                        <li>İyi huylu keratoz benzeri lezyonlar (BKL)</li>
                        <li>Bazal hücreli karsinom (BCC)</li>
                        <li>Aktinik keratoz / intraepitelyal karsinom (AKIEC)</li>
                        <li>Melanositik nevüs (NV)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="form-group">
                <label for="image-input"><i class="fas fa-image"></i> Görüntü Yükleyin:</label>
            <div class="file-upload-wrapper">
                <button class="file-upload-button" onclick="document.getElementById('image-input').click(); return false;">
                        <i class="fas fa-upload"></i> Dosya Seç
                </button>
                    <input 
                        type="file" 
                        id="image-input" 
                        accept="image/jpeg,image/jpg,image/png"
                        aria-label="Görüntü dosyası seçin">
            </div>
            <div class="image-preview">
                <img id="preview-image" alt="Önizleme">
            </div>
        </div>

            <button 
                class="analyze-button ripple" 
                id="analyze-button" 
                onclick="analyzeImage()" 
                disabled
                aria-label="Görüntüyü analiz et"
                aria-busy="false"
                aria-live="polite">
                <i class="fas fa-search" aria-hidden="true"></i> 
                <span id="analyze-button-text">Analiz Et</span>
        </button>

            <div class="loading" id="loading">
                <div class="loading-progress">
                    <div class="spinner"></div>
                    <p id="loading-text">Analiz yapılıyor, lütfen bekleyin...</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progress-bar"></div>
                    </div>
                </div>
            </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 style="margin: 0;"><i class="fas fa-chart-bar"></i> Analiz Sonuçları</h2>
                    <div id="result-actions" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary" id="favorite-btn" onclick="toggleFavorite()" style="margin-right: 10px;">
                            <i class="far fa-heart"></i> Favorilere Ekle
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="share-btn" onclick="shareAnalysis()" style="margin-right: 10px;">
                            <i class="fas fa-share-alt"></i> Paylaş
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="pdf-btn" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> PDF İndir
                        </button>
                    </div>
                </div>
            <div id="gradcam-container" style="margin-bottom: 20px; display: none;">
                    <h3 style="margin-bottom: 10px; color: #333;"><i class="fas fa-eye"></i> Model Odak Bölgeleri (Grad-CAM)</h3>
                <img id="gradcam-image" style="max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);" alt="Grad-CAM Visualization">
                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                    Kırmızı/sarı bölgeler modelin en çok dikkat ettiği alanları gösterir.
                </p>
            </div>
            <div id="results-list"></div>
                <input type="hidden" id="current-analysis-id" value="">
            </div>
        </div>
        </div>
    </div>

    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()" aria-label="Dark mode toggle">
        <i class="fas fa-moon" id="darkModeIcon"></i>
    </button>

    <!-- Appointment Modal -->
    <div class="share-modal" id="appointmentModal" style="max-width: 700px;">
        <h3><i class="fas fa-video"></i> Doktor Randevusu Talep Et</h3>
        <form id="appointmentForm">
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Randevu Tarihi</label>
                <input type="date" class="form-control" id="appointmentDate" required min="">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Randevu Saati</label>
                <select class="form-control" id="appointmentTime" required>
                    <option value="">Saat seçiniz</option>
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Şikayet/Konu</label>
                <textarea class="form-control" id="appointmentReason" rows="3" placeholder="Randevu nedeni, şikayetleriniz veya sorularınız..." required></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Doktor Seçimi (Opsiyonel)</label>
                <select class="form-control" id="appointmentDoctor">
                    <option value="">Herhangi bir doktor</option>
                    <option value="dermatolog">Dermatolog</option>
                    <option value="ortopedist">Ortopedist</option>
                    <option value="gogus-hast">Göğüs Hastalıkları Uzmanı</option>
                    <option value="goz-hast">Göz Hastalıkları Uzmanı</option>
                </select>
            </div>
            <div style="margin-top: 15px;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-calendar-check"></i> Randevu Talep Et
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeAppointmentModal()" style="margin-left: 10px;">
                    İptal
                </button>
            </div>
        </form>
    </div>

    <!-- Feedback Modal -->
    <div class="share-modal" id="feedbackModal" style="max-width: 600px;">
        <h3><i class="fas fa-comment-dots"></i> Geri Bildirim</h3>
        <form id="feedbackForm">
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Geri Bildirim Türü</label>
                <select class="form-control" id="feedbackType" required>
                    <option value="">Seçiniz</option>
                    <option value="bug">Hata Bildirimi</option>
                    <option value="feature">Özellik Önerisi</option>
                    <option value="improvement">İyileştirme Önerisi</option>
                    <option value="other">Diğer</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Değerlendirme</label>
                <div style="text-align: center; font-size: 2rem; margin: 10px 0;">
                    <i class="far fa-star feedback-star" data-rating="1" style="cursor: pointer; color: #ffc107;"></i>
                    <i class="far fa-star feedback-star" data-rating="2" style="cursor: pointer; color: #ffc107;"></i>
                    <i class="far fa-star feedback-star" data-rating="3" style="cursor: pointer; color: #ffc107;"></i>
                    <i class="far fa-star feedback-star" data-rating="4" style="cursor: pointer; color: #ffc107;"></i>
                    <i class="far fa-star feedback-star" data-rating="5" style="cursor: pointer; color: #ffc107;"></i>
                </div>
                <input type="hidden" id="feedbackRating" value="0">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Mesajınız</label>
                <textarea class="form-control" id="feedbackMessage" rows="4" placeholder="Geri bildiriminizi buraya yazın..." required></textarea>
            </div>
            <div style="margin-top: 15px;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Gönder
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()" style="margin-left: 10px;">
                    İptal
                </button>
            </div>
        </form>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="shareModal">
        <h3><i class="fas fa-share-alt"></i> Paylaşım Linki</h3>
        <p>Bu linki paylaşarak analiz sonuçlarınızı başkalarıyla paylaşabilirsiniz:</p>
        <input type="text" class="share-link-input" id="share-link-input" readonly>
        <div style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="copyShareLink()">
                <i class="fas fa-copy"></i> Kopyala
            </button>
            <button class="btn btn-secondary" onclick="closeShareModal()" style="margin-left: 10px;">
                Kapat
            </button>
        </div>
    </div>

    <!-- Config -->
    <script src="js/config.js"></script>
    
    <!-- Firebase & TensorFlow.js -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // API Base URL (config.js'den al)
        const API_BASE_URL = typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001';
        // Global scope'a export et
        window.API_BASE_URL = API_BASE_URL;

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        // Kullanıcı dostu hata mesajları
        const errorMessages = {
            'ERR_CONNECTION_REFUSED': 'Sunucuya bağlanılamıyor. Lütfen daha sonra tekrar deneyin.',
            'auth/invalid-credential': 'E-posta veya şifre hatalı. Lütfen kontrol edin.',
            'auth/network-request-failed': 'İnternet bağlantınızı kontrol edin.',
            'auth/email-already-in-use': 'Bu e-posta adresi zaten kullanımda.',
            'auth/weak-password': 'Şifre çok zayıf. En az 6 karakter olmalıdır.',
            'auth/user-not-found': 'Kullanıcı bulunamadı.',
            'auth/wrong-password': 'Şifre hatalı.',
            'auth/too-many-requests': 'Çok fazla başarısız deneme. Lütfen daha sonra tekrar deneyin.',
            'default': 'Bir hata oluştu. Lütfen sayfayı yenileyin.'
        };

        // Toast notification sistemi - Yeniden yazıldı
        window.showToast = function(message, type = 'success') {
            // Önceki toast'ları kaldır
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(t => t.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            // Toast'u göster (animasyon için)
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Toast süresini mesaj tipine göre ayarla - Minimum 5 saniye
            const duration = type === 'error' ? 8000 : type === 'warning' ? 6000 : 5000;
            
            // Toast'u kaldır
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        };

        // Kullanıcı dostu hata göster
        window.showUserFriendlyError = function(error) {
            let message = errorMessages['default'];
            if (error && error.code) {
                message = errorMessages[error.code] || errorMessages['default'];
            } else if (error && error.message) {
                // Teknik hata mesajlarını kontrol et
                const errorMsg = error.message.toLowerCase();
                if (errorMsg.includes('connection refused') || errorMsg.includes('failed to fetch')) {
                    message = errorMessages['ERR_CONNECTION_REFUSED'];
                } else if (errorMsg.includes('network')) {
                    message = errorMessages['auth/network-request-failed'];
                }
            }
            showToast(message, 'error');
            showError(message);
        };

        // Image compression
        window.compressImage = async function(file, maxWidth = 1920, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Image compression failed'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // Input validation
        window.validateImageFile = function(file) {
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
            const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png'];

            if (!file) {
                showToast('Lütfen bir dosya seçin.', 'error');
                return false;
            }

            if (file.size > MAX_FILE_SIZE) {
                showToast('Dosya boyutu 10MB\'dan küçük olmalıdır.', 'error');
                return false;
            }

            if (!ALLOWED_TYPES.includes(file.type)) {
                const fileExtension = file.name.split('.').pop().toUpperCase();
                showToast(`Yüklediğiniz görüntü formatı (${fileExtension}) desteklenmiyor. Lütfen JPEG veya PNG formatında bir görüntü yükleyin.`, 'error');
                return false;
            }

            return true;
        };

        // Progress bar update
        window.updateProgress = function(percent, text) {
            const progressBar = document.getElementById('progress-bar');
            const loadingText = document.getElementById('loading-text');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
            if (loadingText) {
                loadingText.textContent = text || 'İşleniyor...';
            }
        };
        
        // Firebase Config (config.js'den al veya varsayılan kullan)
        const firebaseConfig = typeof config !== 'undefined' && config.firebase 
            ? config.firebase 
            : {
                apiKey: "AIzaSyBPcwGb9N_fHXA6TPaztHbn9Dg-8lvoq2I",
                authDomain: "medianalytica-71c1d.firebaseapp.com",
                projectId: "medianalytica-71c1d",
                storageBucket: "medianalytica-71c1d.firebasestorage.app",
                messagingSenderId: "965944324546",
                appId: "1:965944324546:web:d0731f60ec2b28748fa65b",
                measurementId: "G-61JFBSYM94"
            };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);
        
        // Global scope'a export et (diğer fonksiyonlar için)
        window.auth = auth;
        window.db = db;
        window.storage = storage;

        // Firebase'e analiz kaydet - Global scope'a export et
        window.saveAnalysisToFirebase = async function(diseaseType, results, topPrediction, imageFile) {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) {
                    console.warn('Kullanıcı giriş yapmamış, analiz kaydedilemiyor');
                    return;
                }

                // Görüntüyü Firebase Storage'a yükle
                let imageUrl = '';
                if (imageFile) {
                    const storageRef = ref(storage, `analysis_images/${user.uid}/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(storageRef);
                    console.log('Görüntü yüklendi:', imageUrl);
                }

                // Backend API'ye analiz kaydet
                const token = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/user/analyses`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        diseaseType: diseaseType,
                        results: results.map(item => ({
                            class: item.class,
                            confidence: item.confidence
                        })),
                        topPrediction: topPrediction,
                        imageUrl: imageUrl
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Analiz Firebase\'e kaydedildi:', data);
                    return data.analysisId || null;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                        console.error('Analiz kaydetme hatası:', errorData);
                        showToast(`Analiz kaydedilemedi: ${errorData.error || errorText}`, 'error');
                    } catch (e) {
                    console.error('Analiz kaydetme hatası:', errorText);
                        showToast(`Analiz kaydedilemedi: ${errorText}`, 'error');
                    }
                    return null;
                }
            } catch (error) {
                console.error('Firebase kayıt hatası:', error);
                return null;
            }
        };

        // Profil menüsü toggle
        document.getElementById('profileBtn').addEventListener('click', async (e) => {
            e.stopPropagation();
            const menu = document.getElementById('profileMenu');
            const isOpening = !menu.classList.contains('show');
            menu.classList.toggle('show');
            
            // Menü açılırken profil fotoğrafını yeniden yükle
            if (isOpening) {
                const user = (window.auth || auth)?.currentUser;
                if (user) {
                    try {
                        const token = await user.getIdToken();
                        await loadProfilePhoto(user, token);
                    } catch (error) {
                        console.error('Profil fotoğrafı yüklenirken hata:', error);
                    }
                }
            }
        });

        // Dışarı tıklanınca menüyü kapat
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.profile-dropdown')) {
                document.getElementById('profileMenu').classList.remove('show');
            }
        });

        // Çıkış yap
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                localStorage.removeItem("firebase_id_token");
                window.location.href = "templates/login.html";
            } catch (error) {
                console.error('Çıkış hatası:', error);
            }
        });

        // Profil ayarları - Basit ve çalışan versiyon
        document.getElementById('profileSettingsBtn').addEventListener('click', () => {
            showProfileSettings();
        });

        // Profil ayarlarını göster
        window.showProfileSettings = function() {
            const user = (window.auth || auth)?.currentUser;
            if (!user) {
                showToast('Giriş yapmalısınız.', 'warning');
                return;
            }

            // Modal'ı oluştur veya göster
            let modal = document.getElementById('profileModal');
            if (!modal) {
                // Modal yoksa oluştur
                modal = document.createElement('div');
                modal.id = 'profileModal';
                modal.className = 'share-modal';
                modal.style.cssText = 'max-width: 600px; z-index: 2000;';
                modal.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Profil Ayarları</h3>
                        <button type="button" onclick="closeProfileSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-600); padding: 0; width: 30px; height: 30px;">&times;</button>
                    </div>
                    <form id="profileSettingsForm">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 600; color: var(--gray-800); margin-bottom: 8px; display: block;">İsim</label>
                            <input type="text" class="form-control" id="profile-display-name" placeholder="İsminiz" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; width: 100%;">
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <label style="font-weight: 600; color: var(--gray-800); margin: 0;">Profil Fotoğrafı</label>
                                <button type="button" id="profile-photo-upload-btn" style="padding: 6px 16px; border-radius: 6px; font-size: 0.9rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; font-weight: 500;">Yükle</button>
                            </div>
                            <input type="file" class="form-control" id="profile-photo-input" accept="image/*" style="display: none;">
                            <img id="profile-photo-preview" style="max-width: 150px; margin-top: 10px; border-radius: 50%; display: none; border: 3px solid var(--primary);" alt="Profil fotoğrafı">
                        </div>
                        <div class="form-group" style="margin-bottom: 25px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600; color: var(--gray-800);">
                                <input type="checkbox" id="profile-notifications" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                Bildirimleri aç
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button type="button" class="btn btn-secondary" onclick="closeProfileSettings()" style="flex: 1; padding: 12px; border-radius: 10px; font-size: 1rem;">İptal</button>
                            <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; border-radius: 10px; font-size: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                                Kaydet
                            </button>
                        </div>
                    </form>
                `;
                document.body.appendChild(modal);

                // Form submit event
                document.getElementById('profileSettingsForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await saveProfileSettings();
                });

                // Fotoğraf önizleme
                document.getElementById('profile-photo-input').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('profile-photo-preview').src = event.target.result;
                            document.getElementById('profile-photo-preview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Yükle butonu - dosya seçimini tetikle
                document.getElementById('profile-photo-upload-btn').addEventListener('click', function() {
                    document.getElementById('profile-photo-input').click();
                });
            }

            // Kullanıcı bilgilerini yükle
            document.getElementById('profile-display-name').value = user.displayName || user.email?.split('@')[0] || '';

            // Backdrop ekle
            if (!document.getElementById('profileModalBackdrop')) {
                const backdrop = document.createElement('div');
                backdrop.id = 'profileModalBackdrop';
                backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;';
                backdrop.onclick = closeProfileSettings;
                document.body.appendChild(backdrop);
            }

            // Modal'ı göster
            modal.classList.add('show');
            modal.style.display = 'block';
        };

        // Profil ayarlarını kapat
        window.closeProfileSettings = function() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
            const backdrop = document.getElementById('profileModalBackdrop');
            if (backdrop) {
                backdrop.remove();
            }
        };

        // Profil ayarlarını kaydet
        window.saveProfileSettings = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) {
                    showToast('Giriş yapmalısınız.', 'warning');
                    return;
                }

                const displayName = document.getElementById('profile-display-name').value;
                const notifications = document.getElementById('profile-notifications').checked;
                const photoFile = document.getElementById('profile-photo-input').files[0];

                // Firebase'e kaydet
                if (displayName) {
                    await updateProfile(user, { displayName: displayName });
                }

                // Backend API'ye kaydet (opsiyonel)
                try {
                    const token = await user.getIdToken();
                    const apiUrl = window.API_BASE_URL || API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                    
                    if (photoFile) {
                        const formData = new FormData();
                        formData.append('photo', photoFile);
                        const photoResponse = await fetch(`${apiUrl}/api/user/profile/photo`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData
                        });
                        
                        if (photoResponse.ok) {
                            const photoData = await photoResponse.json();
                            if (photoData.success && photoData.photoURL) {
                                // Firebase Auth'da da güncelle
                                await updateProfile(user, { photoURL: photoData.photoURL });
                                // Kullanıcı nesnesini yeniden yükle
                                await user.reload();
                                // Profil fotoğrafını hemen göster (API'den gelen URL ile)
                                const profilePhotoImg = document.getElementById('profileBtnPhoto');
                                const profileMenuPhotoImg = document.getElementById('profileMenuPhoto');
                                
                                if (profilePhotoImg) {
                                    profilePhotoImg.src = photoData.photoURL;
                                    profilePhotoImg.style.display = 'block';
                                }
                                if (profileMenuPhotoImg) {
                                    profileMenuPhotoImg.src = photoData.photoURL;
                                    profileMenuPhotoImg.style.display = 'block';
                                    profileMenuPhotoImg.style.position = 'absolute';
                                    profileMenuPhotoImg.style.top = '0';
                                    profileMenuPhotoImg.style.left = '0';
                                }
                                
                                // Profil fotoğrafını yeniden yükle (güncellenmiş user ile)
                                const updatedUser = (window.auth || auth)?.currentUser;
                                await loadProfilePhoto(updatedUser || user, token);
                            }
                        }
                    }

                    await fetch(`${apiUrl}/api/user/profile`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            displayName: displayName,
                            settings: {
                                notifications: notifications,
                                language: 'tr'
                            }
                        })
                    });
                } catch (apiError) {
                    console.warn('Backend API hatası:', apiError);
                }

                closeProfileSettings();
                showToast('Profil başarıyla güncellendi!', 'success');
                
                // Kullanıcı bilgilerini güncelle
                if (displayName) {
                    document.getElementById('userName').textContent = displayName;
                }
            } catch (error) {
                console.error('Profil kaydetme hatası:', error);
                showToast('Profil güncellenirken hata oluştu.', 'error');
            }
        };

        // Favoriler
        document.getElementById('favoritesBtn').addEventListener('click', () => {
            showSection('favorites', null);
        });

        // Kullanıcı bilgilerini yükle
        // Sayfa yüklendiğinde authentication kontrolü
        onAuthStateChanged(window.auth || auth, async (user) => {
            // 1. Kullanıcı giriş yapmamışsa → Login sayfasına yönlendir
            if (!user) {
                // localStorage'da token varsa temizle (eski oturum)
                localStorage.removeItem("firebase_id_token");
                window.location.href = "templates/login.html";
                return;
            }
            
            // 2. Doktor kontrolü - Doktor ise doktor paneline yönlendir
            try {
                const token = await user.getIdToken();
                const doctorCheck = await fetch(`${API_BASE_URL}/api/doctors/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (doctorCheck.ok) {
                    const doctorData = await doctorCheck.json();
                    if (doctorData.doctor) {
                        // Doktor kaydı var → Doktor paneline yönlendir
                        localStorage.setItem("firebase_id_token", token);
                        window.location.href = "templates/doctor-dashboard.html";
                    return;
                    }
                }
                    } catch (error) {
                // Doktor kontrolü başarısız, normal kullanıcı olarak devam et
                console.log('Doctor check failed, continuing as regular user');
            }
            
            // 2. Kullanıcı giriş yapmış → Normal akış
            try {
                // Dashboard'ı göster
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection) {
                    dashboardSection.style.display = 'block';
                }
                
                // Token'i localStorage'a kaydet
                const token = await user.getIdToken();
                localStorage.setItem("firebase_id_token", token);
                
                const displayName = user.displayName || user.email?.split('@')[0] || 'Kullanıcı';
                document.getElementById('userName').textContent = displayName;
                document.getElementById('profileEmail').textContent = user.email || '-';
                
                // Üyelik tarihi (Firebase'den gelirse)
                if (user.metadata && user.metadata.creationTime) {
                    const joinDate = new Date(user.metadata.creationTime);
                    document.getElementById('profileJoinDate').textContent = `Üyelik: ${joinDate.toLocaleDateString('tr-TR')}`;
                }
                
                // Profil fotoğrafını yükle
                await loadProfilePhoto(user, token);
            } catch (error) {
                console.error('Token alınamadı:', error);
                // Hata durumunda login'e yönlendir
                window.location.href = "templates/login.html";
            }
        });

        // Profil fotoğrafını yükle
        window.loadProfilePhoto = async function(user, token) {
            try {
                const profilePhotoImg = document.getElementById('profileBtnPhoto');
                const profileMenuPhotoImg = document.getElementById('profileMenuPhoto');
                
                if (!profilePhotoImg && !profileMenuPhotoImg) return;

                let photoURL = null;

                // Önce Firebase Auth'dan kontrol et
                if (user.photoURL) {
                    photoURL = user.photoURL;
                } else {
                    // Backend API'den profil bilgilerini al
                    try {
                        const apiUrl = window.API_BASE_URL || API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                        const response = await fetch(`${apiUrl}/api/user/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.profile && data.profile.photoURL) {
                                photoURL = data.profile.photoURL;
                            }
                        }
                    } catch (apiError) {
                        console.warn('Profil fotoğrafı API\'den alınamadı:', apiError);
                    }
                }

                // Fotoğraf varsa göster
                if (photoURL) {
                    console.log('Profil fotoğrafı yükleniyor:', photoURL);
                    // Profile button photo
                    if (profilePhotoImg) {
                        profilePhotoImg.src = photoURL;
                        profilePhotoImg.style.display = 'block';
                        profilePhotoImg.onerror = function() {
                            console.error('Profil butonu fotoğrafı yüklenemedi:', photoURL);
                            profilePhotoImg.style.display = 'none';
                        };
                        profilePhotoImg.onload = function() {
                            console.log('Profil butonu fotoğrafı yüklendi');
                        };
                    }
                    
                    // Profile menu photo
                    if (profileMenuPhotoImg) {
                        profileMenuPhotoImg.src = photoURL;
                        profileMenuPhotoImg.style.display = 'block';
                        profileMenuPhotoImg.style.position = 'absolute';
                        profileMenuPhotoImg.style.top = '0';
                        profileMenuPhotoImg.style.left = '0';
                        profileMenuPhotoImg.onerror = function() {
                            console.error('Profil menü fotoğrafı yüklenemedi:', photoURL);
                            profileMenuPhotoImg.style.display = 'none';
                        };
                        profileMenuPhotoImg.onload = function() {
                            console.log('Profil menü fotoğrafı yüklendi');
                        };
                    }
                } else {
                    console.log('Profil fotoğrafı bulunamadı');
                    // Fotoğraf yoksa gizle
                    if (profilePhotoImg) {
                        profilePhotoImg.style.display = 'none';
                    }
                    if (profileMenuPhotoImg) {
                        profileMenuPhotoImg.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Profil fotoğrafı yüklenirken hata:', error);
            }
        };

        // Randevuları yükle
        window.loadAppointments = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const statusFilter = document.getElementById('appointment-filter-status')?.value || '';
                
                let url = `${API_BASE_URL}/api/appointments`;
                if (statusFilter) {
                    url += `?status=${statusFilter}`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const appointments = data.appointments || [];
                    
                    const container = document.getElementById('appointments-content');
                    
                    if (appointments.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-calendar-times" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 15px;"></i>
                                <h3>Henüz randevu talebiniz yok</h3>
                                <p>Doktor ile görüntülü görüşme için yeni bir randevu talep edebilirsiniz.</p>
                                <button class="btn btn-primary" onclick="showAppointmentModal()">
                                    <i class="fas fa-plus"></i> Randevu Talep Et
                                </button>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div class="row">';
                    appointments.forEach(appointment => {
                        const statusColors = {
                            'pending': '#ffc107',
                            'approved': '#28a745',
                            'rejected': '#dc3545',
                            'completed': '#6c757d'
                        };
                        const statusTexts = {
                            'pending': 'Beklemede',
                            'approved': 'Onaylandı',
                            'rejected': 'Reddedildi',
                            'completed': 'Tamamlandı'
                        };
                        const status = appointment.status || 'pending';
                        const statusColor = statusColors[status] || '#6c757d';
                        const statusText = statusTexts[status] || status;

                        // Tarih formatla
                        const date = new Date(appointment.date);
                        const formattedDate = date.toLocaleDateString('tr-TR', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });

                        html += `
                            <div class="col-md-6" style="margin-bottom: 15px;">
                                <div class="card" style="border-left: 4px solid ${statusColor};">
                                    <div class="card-body">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <h5 style="margin: 0;">
                                                <i class="fas fa-calendar"></i> ${formattedDate}
                                            </h5>
                                            <span class="badge" style="background: ${statusColor}; color: white; padding: 5px 10px; border-radius: 15px;">
                                                ${statusText}
                                            </span>
                                        </div>
                                        <p style="margin: 5px 0; color: #666;">
                                            <i class="fas fa-clock"></i> ${appointment.time}
                                        </p>
                                        ${appointment.doctorType ? `
                                            <p style="margin: 5px 0; color: #666;">
                                                <i class="fas fa-user-md"></i> ${appointment.doctorType}
                                            </p>
                                        ` : ''}
                                        <p style="margin: 10px 0; color: #333;">
                                            <strong>Konu:</strong> ${appointment.reason || '-'}
                                        </p>
                                        ${status === 'approved' ? `
                                            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="btn btn-success btn-sm" onclick="joinAppointment('${appointment.id}')">
                                                    <i class="fas fa-video"></i> Görüntülü Görüşmeye Katıl
                                                </button>
                                                <button class="btn btn-info btn-sm" onclick="shareAppointmentLink('${appointment.id}')" title="Linki paylaş">
                                                    <i class="fas fa-share-alt"></i> Linki Paylaş
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    document.getElementById('appointments-content').innerHTML = 
                        '<p style="color: var(--danger);">Randevular yüklenirken bir hata oluştu.</p>';
                }
            } catch (error) {
                console.error('Appointments load error:', error);
                document.getElementById('appointments-content').innerHTML = 
                    '<p style="color: var(--danger);">Randevular yüklenirken bir hata oluştu.</p>';
            }
        };

        // Aktif randevuları yükle (sadece onaylananlar - Randevu Talep bölümü altında gösterilir)
        window.loadActiveAppointments = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const apiUrl = window.API_BASE_URL || API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                
                // Sadece onaylanan randevuları getir
                const response = await fetch(`${apiUrl}/api/appointments?status=approved`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const appointments = data.appointments || [];
                    
                    const container = document.getElementById('active-appointments-content');
                    if (!container) return;
                    
                    if (appointments.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state" style="text-align: center; padding: 40px;">
                                <i class="fas fa-calendar-times" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 15px;"></i>
                                <h3 style="color: var(--gray-600);">Henüz aktif randevunuz yok</h3>
                                <p style="color: var(--gray-500);">Onaylanan randevularınız burada görünecektir.</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div class="row">';
                    appointments.forEach(appointment => {
                        // Tarih formatla
                        const date = new Date(appointment.date);
                        const formattedDate = date.toLocaleDateString('tr-TR', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });

                        html += `
                            <div class="col-md-6" style="margin-bottom: 20px;">
                                <div class="card" style="border-left: 4px solid #28a745; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                    <div class="card-body">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                            <h5 style="margin: 0; color: #28a745;">
                                                <i class="fas fa-calendar-check"></i> ${formattedDate}
                                            </h5>
                                            <span class="badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 15px;">
                                                Onaylandı
                                            </span>
                                        </div>
                                        <p style="margin: 8px 0; color: #666;">
                                            <i class="fas fa-clock"></i> <strong>Saat:</strong> ${appointment.time}
                                        </p>
                                        ${appointment.doctorType ? `
                                            <p style="margin: 8px 0; color: #666;">
                                                <i class="fas fa-user-md"></i> <strong>Doktor:</strong> ${appointment.doctorType}
                                            </p>
                                        ` : ''}
                                        <p style="margin: 10px 0; color: #333;">
                                            <strong>Konu:</strong> ${appointment.reason || '-'}
                                        </p>
                                        <div style="margin-top: 15px;">
                                            <button class="btn btn-success btn-lg" onclick="joinAppointment('${appointment.id}')" style="width: 100%; padding: 12px; border-radius: 10px; font-size: 1.1rem; font-weight: 600;">
                                                <i class="fas fa-video"></i> Görüntülü Görüşmeye Katıl
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    const container = document.getElementById('active-appointments-content');
                    if (container) {
                        container.innerHTML = 
                            '<p style="color: var(--danger); text-align: center; padding: 20px;">Randevular yüklenirken bir hata oluştu.</p>';
                    }
                }
            } catch (error) {
                console.error('Active appointments load error:', error);
                const container = document.getElementById('active-appointments-content');
                if (container) {
                    container.innerHTML = 
                        '<p style="color: var(--danger); text-align: center; padding: 20px;">Randevular yüklenirken bir hata oluştu.</p>';
                }
            }
        };

        // Randevuya katıl (Jitsi Meet)
        window.joinAppointment = async function(appointmentId) {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) {
                    showToast('Giriş yapmalısınız.', 'warning');
                    return;
                }

                const token = await user.getIdToken();
                const apiUrl = window.API_BASE_URL || API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                const response = await fetch(`${apiUrl}/api/appointments/${appointmentId}/join`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Jitsi Meet sayfasına yönlendir
                    window.location.href = `templates/appointment.html?id=${appointmentId}`;
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Randevuya katılamadınız.', 'error');
                }
            } catch (error) {
                console.error('Join appointment error:', error);
                showToast('Randevuya katılırken bir hata oluştu.', 'error');
            }
        };
    </script>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script>
        // Model ve sınıf tanımlamaları
        let currentModel = null;
        let modelReady = false;
        let currentClasses = {};

        // Model yolları ve sınıfları
        const modelConfigs = {
            bone: {
                useBackend: true,
                apiUrl: 'http://localhost:5002/predict',
                classes: {
                    0: 'Normal',
                    1: 'Fracture',
                    2: 'Benign_Tumor',
                    3: 'Malignant_Tumor'
                }
            },
            skin: {
                useBackend: true,
                apiUrl: 'http://localhost:5003/predict',
                classes: {
                    0: 'akiec',
                    1: 'bcc',
                    2: 'bkl',
                    3: 'mel',
                    4: 'nv'
                }
            },
            lung: {
                useBackend: false,
                path: './models/lung_disease_model.keras',
                classes: {
                    0: 'Normal',
                    1: 'Pneumonia'
                }
            },
            eye: {
                useBackend: false,
                path: './models/eye_disease_model_5class.keras',
                classes: {
                    0: 'Normal',
                    1: 'Cataract',
                    2: 'Glaucoma',
                    3: 'Retina Disease',
                    4: 'Other'
                }
            }
        };

        // Model yükleme
        async function loadModel(diseaseType) {
            const config = modelConfigs[diseaseType];
            if (!config) {
                showError('Geçersiz hastalık türü seçildi.');
                return;
            }

            try {
                updateModelStatus('loading', 'Model yükleniyor...');
                
                if (config.useBackend) {
                    updateModelStatus('loading', 'Backend API kontrol ediliyor...');
                    
                    try {
                        const statusUrl = config.apiUrl.replace('/predict', '/');
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(statusUrl, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`API yanıt vermedi: ${response.status}`);
                        }
                        
                        await response.json();
                        currentModel = 'backend';
                        currentClasses = config.classes;
                        modelReady = true;
                        updateModelStatus('ready', '✅ Backend API hazır! Analiz yapabilirsiniz.');
                        document.getElementById('analyze-button').disabled = false;
                        
                    } catch (error) {
                        let errorMessage = '❌ Backend API\'ye bağlanılamıyor! ';
                        
                        if (error.name === 'AbortError') {
                            errorMessage += 'Bağlantı zaman aşımına uğradı (3 saniye). ';
                        } else if (error.message && error.message.includes('Failed to fetch')) {
                            errorMessage += 'API kapalı olabilir. ';
                        } else if (error.message) {
                            errorMessage += error.message + '. ';
                        }
                        
                        const apiCommands = {
                            'bone': 'python3 bone_disease_api.py',
                            'skin': 'python3 skin_disease_api.py',
                            'lung': 'python3 lung_disease_api.py',
                            'eye': 'python3 eye_disease_api.py'
                        };
                        const apiPorts = {
                            'bone': '5002',
                            'skin': '5003',
                            'lung': '5004',
                            'eye': '5005'
                        };
                        const diseaseType = document.getElementById('disease-type').value;
                        const apiCommand = apiCommands[diseaseType] || 'python3 [disease]_api.py';
                        const apiPort = apiPorts[diseaseType] || 'PORT';
                        errorMessage += `\n\n📋 API'yi başlatmak için terminalde:\ncd Skin-Disease-Classifier\nsource venv/bin/activate\n${apiCommand}\n\nPort: ${apiPort}`;
                        
                        updateModelStatus('error', errorMessage);
                        currentModel = null;
                        modelReady = false;
                        document.getElementById('analyze-button').disabled = true;
                    }
                    return;
                }
                
                let modelPath = config.path;
                
                if (modelPath.endsWith('.keras')) {
                    updateModelStatus('error', 
                        '❌ .keras formatı TensorFlow.js ile kullanılamaz!\n\n' +
                        '📋 Çözüm: Backend API kullanın veya modeli dönüştürün');
                    currentModel = null;
                    modelReady = false;
                    return;
                }

                console.log('Model yükleniyor:', modelPath);
                currentModel = await tf.loadLayersModel(modelPath);
                currentClasses = config.classes;
                modelReady = true;
                updateModelStatus('ready', '✅ Model hazır! Analiz yapabilirsiniz.');
                document.getElementById('analyze-button').disabled = false;
                
            } catch (error) {
                console.error('Model yükleme hatası:', error);
                updateModelStatus('error', 
                    '❌ Model yüklenemedi!\n\n' +
                    'Kontrol edin:\n' +
                    '• Model dosyası mevcut mu?\n' +
                    '• Dosya yolları doğru mu?\n' +
                    '• Backend API kullanmayı deneyin');
                currentModel = null;
                modelReady = false;
            }
        }

        function updateModelStatus(status, message) {
            const statusDiv = document.getElementById('model-status');
            statusDiv.className = 'model-status ' + status;
            statusDiv.textContent = message;

            // Buton durumunu güncelle
            const analyzeBtn = document.getElementById('analyze-button');
            const analyzeBtnText = document.getElementById('analyze-button-text');
            
            if (status === 'ready') {
                analyzeBtn.disabled = false;
                analyzeBtnText.textContent = 'Analiz Et';
            } else if (status === 'loading') {
                analyzeBtn.disabled = true;
                analyzeBtnText.textContent = 'Model Yükleniyor...';
            } else if (status === 'error') {
                analyzeBtn.disabled = true;
                analyzeBtnText.textContent = 'Model Hazır Değil';
            }
        }

        document.getElementById('image-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file format and size before processing
                if (!validateImageFile(file)) {
                    // Clear the file input if validation fails
                    e.target.value = '';
                    // Hide preview if it was shown
                    const img = document.getElementById('preview-image');
                    img.classList.remove('show');
                    img.src = '';
                    // Disable analyze button
                    document.getElementById('analyze-button').disabled = true;
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.getElementById('preview-image');
                    img.src = event.target.result;
                    img.classList.add('show');
                    // Model hazırsa butonu aktif et
                    const analyzeBtn = document.getElementById('analyze-button');
                    analyzeBtn.disabled = !modelReady;
                    console.log('Fotoğraf yüklendi. Model hazır mı?', modelReady);
                    if (!modelReady) {
                        showError('Lütfen önce hastalık türü seçin ve model yüklenmesini bekleyin.');
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('disease-type').addEventListener('change', function(e) {
            const diseaseType = e.target.value;
            const skinWarning = document.getElementById('skin-disease-warning');
            
            // Show/hide skin disease warning
            if (diseaseType === 'skin') {
                skinWarning.style.display = 'block';
            } else {
                skinWarning.style.display = 'none';
            }
            
            if (diseaseType) {
                loadModel(diseaseType);
                document.getElementById('analyze-button').disabled = true;
                document.getElementById('results').classList.remove('show');
            } else {
                currentModel = null;
                modelReady = false;
                updateModelStatus('loading', 'Hastalık türü seçin...');
            }
        });

        // Sayfa yüklendiğinde, eğer bir hastalık türü seçiliyse otomatik model yükle
        document.addEventListener('DOMContentLoaded', function() {
            const diseaseTypeSelect = document.getElementById('disease-type');
            const skinWarning = document.getElementById('skin-disease-warning');
            
            if (diseaseTypeSelect && diseaseTypeSelect.value) {
                // Show/hide skin disease warning if skin is selected
                if (diseaseTypeSelect.value === 'skin') {
                    skinWarning.style.display = 'block';
                } else {
                    skinWarning.style.display = 'none';
                }
                
                // Kısa bir gecikme ile model yükle (sayfa tamamen yüklensin)
                setTimeout(() => {
                    loadModel(diseaseTypeSelect.value);
                }, 500);
            }
        });

        async function analyzeImage() {
            console.log('Analiz butonuna tıklandı. Model hazır mı?', modelReady, 'Model:', currentModel);
            
            if (!modelReady || !currentModel) {
                showError('Lütfen önce hastalık türü seçin ve model yüklenmesini bekleyin.');
                return;
            }

            const fileInput = document.getElementById('image-input');
            if (!fileInput.files || !fileInput.files[0]) {
                showError('Lütfen bir görüntü seçin.');
                return;
            }

            const diseaseType = document.getElementById('disease-type').value;
            if (!diseaseType) {
                showError('Lütfen önce hastalık türü seçin.');
                return;
            }

            try {
                document.getElementById('loading').classList.add('show');
                document.getElementById('results').classList.remove('show');
                document.getElementById('error').classList.remove('show');
                document.getElementById('analyze-button').disabled = true;

                const config = modelConfigs[document.getElementById('disease-type').value];
                
                if (currentModel === 'backend' && config.useBackend) {
                    const formData = new FormData();
                    formData.append('image', fileInput.files[0]);
                    formData.append('with_gradcam', 'true');

                    updateProgress(70, 'Analiz yapılıyor...');
                    const response = await fetch(config.apiUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`API hatası: ${response.status}`);
                    }

                    updateProgress(85, 'Sonuçlar alınıyor...');
                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    updateProgress(95, 'Sonuçlar kaydediliyor...');

                    const results = data.top_3.map(item => ({
                        probability: item.confidence,
                        className: item.class_tr || item.class
                    }));

                    if (data.gradcam) {
                        const gradcamImg = document.getElementById('gradcam-image');
                        gradcamImg.src = data.gradcam;
                        document.getElementById('gradcam-container').style.display = 'block';
                    } else {
                        document.getElementById('gradcam-container').style.display = 'none';
                        if (data.gradcam_error) {
                            console.warn('Grad-CAM hatası:', data.gradcam_error);
                        }
                    }

                    displayResults(results, data);
                    
                    // Firebase'e analiz kaydet
                    const analysisId = await saveAnalysisToFirebase(
                        document.getElementById('disease-type').value,
                        data.top_3,
                        data.prediction.class,
                        fileInput.files[0]
                    );
                    
                    // Analiz ID'sini sakla (favoriler ve paylaşım için)
                    if (analysisId) {
                        document.getElementById('current-analysis-id').value = analysisId;
                        document.getElementById('result-actions').style.display = 'flex';
                    }
                    
                    updateProgress(100, 'Tamamlandı!');
                    showToast('Analiz başarıyla tamamlandı!', 'success');

                } else {
                    const image = document.getElementById('preview-image');
                    const tensor = tf.browser.fromPixels(image)
                        .resizeNearestNeighbor([224, 224])
                        .toFloat();

                    const offset = tf.scalar(127.5);
                    const normalized = tensor.sub(offset)
                        .div(offset)
                        .expandDims();

                    const predictions = await currentModel.predict(normalized).data();

                    const results = Array.from(predictions)
                        .map((prob, index) => ({
                            probability: prob,
                            className: currentClasses[index] || `Sınıf ${index}`
                        }))
                        .sort((a, b) => b.probability - a.probability)
                        .slice(0, 3);

                    displayResults(results, data);

                    tensor.dispose();
                    normalized.dispose();
                }

            } catch (error) {
                console.error('Analiz hatası:', error);
                showUserFriendlyError(error);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('analyze-button').disabled = !modelReady;
                document.getElementById('analyze-button').setAttribute('aria-busy', 'false');
                updateProgress(0, '');
            }
        }

        let currentAnalysisData = null;

        function displayResults(results, fullData = null) {
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';
            currentAnalysisData = fullData || { top_3: results };

            results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                
                const label = document.createElement('span');
                label.className = 'result-label';
                label.textContent = result.className || result.class_tr || result.class;

                const probability = document.createElement('span');
                probability.className = 'result-probability';
                probability.textContent = ((result.probability || result.confidence || 0) * 100).toFixed(2) + '%';

                resultDiv.appendChild(label);
                resultDiv.appendChild(probability);
                resultsList.appendChild(resultDiv);
            });

            document.getElementById('results').classList.add('show');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Empty state helper
        window.showEmptyState = function(containerId, icon, title, message, actionText, actionCallback) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-${icon}"></i>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    ${actionText ? `<button class="btn btn-primary" onclick="${actionCallback}">${actionText}</button>` : ''}
                </div>
            `;
        };


        // İstatistikleri yükle - Global scope'a export et
        window.loadStats = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/user/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const stats = data.stats || {};
                    
                    const statsHtml = `
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-title">Toplam Analiz</div>
                                    <div class="stats-value">${stats.totalAnalyses || 0}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-title">Kemik</div>
                                    <div class="stats-value">${stats.diseaseTypeCounts?.bone || 0}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-title">Deri</div>
                                    <div class="stats-value">${stats.diseaseTypeCounts?.skin || 0}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-title">En Çok Analiz</div>
                                    <div class="stats-value" style="font-size: 1.2rem;">${stats.mostAnalyzedDisease || '-'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('stats-content').innerHTML = statsHtml;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                        console.error('İstatistik yükleme hatası:', errorData);
                        document.getElementById('stats-content').innerHTML = `<p class="text-danger">İstatistikler yüklenemedi: ${errorData.error || errorText}</p>`;
                    } catch (e) {
                        console.error('İstatistik yükleme hatası:', errorText);
                        document.getElementById('stats-content').innerHTML = `<p class="text-danger">İstatistikler yüklenemedi: ${errorText}</p>`;
                    }
                }
            } catch (error) {
                console.error('İstatistik yükleme hatası:', error);
                document.getElementById('stats-content').innerHTML = '<p class="text-danger">İstatistikler yüklenemedi.</p>';
            }
        };

        // Analiz geçmişini yükle - Global scope'a export et
        window.loadHistory = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/user/analyses?limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const analyses = data.analyses || [];
                    
                    if (analyses.length === 0) {
                        showEmptyState('history-content', 'inbox', 'Henüz analiz yapılmamış', 'İlk analizinizi yapmak için yukarıdaki butona tıklayın.', 'Analiz Yap', 'document.querySelector(\'.analysis-card\').scrollIntoView({behavior: \'smooth\'})');
                        return;
                    }

                    const historyHtml = analyses.map(analysis => {
                        const date = new Date(analysis.createdAt * 1000).toLocaleDateString('tr-TR');
                        return `
                            <div class="result-item" style="margin-bottom: 10px;">
                                <div>
                                    <strong>${analysis.diseaseType}</strong> - ${analysis.topPrediction || 'N/A'}<br>
                                    <small>${date}</small>
                                </div>
                                ${analysis.imageUrl ? `<img src="${analysis.imageUrl}" style="max-width: 100px; border-radius: 5px;" alt="Analiz görüntüsü">` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('history-content').innerHTML = historyHtml;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                        console.error('Analiz geçmişi yükleme hatası:', errorData);
                        document.getElementById('history-content').innerHTML = `<p class="text-danger">Analiz geçmişi yüklenemedi: ${errorData.error || errorText}</p>`;
                    } catch (e) {
                        console.error('Analiz geçmişi yükleme hatası:', errorText);
                        document.getElementById('history-content').innerHTML = `<p class="text-danger">Analiz geçmişi yüklenemedi: ${errorText}</p>`;
                    }
                }
            } catch (error) {
                console.error('Geçmiş yükleme hatası:', error);
                document.getElementById('history-content').innerHTML = '<p class="text-danger">Analiz geçmişi yüklenemedi.</p>';
            }
        };

        // İstatistikleri göster - Global scope'a export et
        window.showStats = async function() {
            const statsCard = document.getElementById('stats-card');
            const historyCard = document.getElementById('history-card');
            historyCard.style.display = 'none';
            
            if (statsCard.style.display === 'none') {
                statsCard.style.display = 'block';
                await window.loadStats();
            } else {
                statsCard.style.display = 'none';
            }
        };

        // Analiz geçmişini göster - Global scope'a export et
        window.showHistory = async function() {
            const statsCard = document.getElementById('stats-card');
            const historyCard = document.getElementById('history-card');
            statsCard.style.display = 'none';
            
            if (historyCard.style.display === 'none') {
                historyCard.style.display = 'block';
                await window.loadHistory();
            } else {
                historyCard.style.display = 'none';
            }
        };

    </script>

    <!-- Yeni Özellikler: Sidebar Navigation, Favoriler, Paylaşım, PDF, Profil -->
    <script>
        // Sidebar Toggle (Mobile)
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        };

        // Swipe gesture for sidebar (Mobile)
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            // Sağa kaydırma (sidebar aç)
            if (touchEndX - touchStartX > 50 && touchStartX < 50 && !sidebar.classList.contains('open')) {
                sidebar.classList.add('open');
                overlay.classList.add('show');
            }
            
            // Sola kaydırma (sidebar kapat)
            if (touchStartX - touchEndX > 50 && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            }
        }

        // Dark Mode Toggle
        window.toggleDarkMode = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Icon güncelle
            const icon = document.getElementById('darkModeIcon');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        };

        // Dark mode initialization
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('darkModeIcon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        })();

        // Sidebar Navigation
        window.showSection = function(section, eventElement) {
            // Mobile'da sidebar'ı kapat
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
            // Tüm section'ları gizle (daha kapsamlı)
            const allCards = document.querySelectorAll('.welcome-card, .analysis-card');
            allCards.forEach(el => {
                if (el.id !== 'sidebar' && !el.closest('#sidebar')) {
                    el.style.display = 'none';
                }
            });
            
            // Sidebar item'ları güncelle
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Eğer event element varsa, onu aktif yap; yoksa section'a göre bul
            if (eventElement) {
                const sidebarItem = eventElement.closest('.sidebar-item');
                if (sidebarItem) {
                    sidebarItem.classList.add('active');
                }
            } else {
                // Section'a göre sidebar item'ı bul
                const sectionMap = {
                    'dashboard': 'Ana Menü',
                    'analyze': 'Analiz Yap',
                    'history': 'Analiz Geçmişi',
                    'favorites': 'Favoriler',
                    'stats': 'İstatistikler',
                    'appointments': 'Randevularım',
                    'appointment': 'Randevu Talep',
                    'help': 'Yardım',
                    'contact': 'İletişim',
                    'about': 'Hakkımızda',
                    'feedback': 'Geri Bildirim'
                };
                const itemText = sectionMap[section];
                if (itemText) {
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        if (item.textContent.includes(itemText)) {
                            item.classList.add('active');
                        }
                    });
                }
            }
            
            // Tüm section'ları gizle
            const allSections = [
                'dashboard-section', 'analyze', 'history-card', 'favorites-card', 
                'stats-card', 'appointments-card', 'appointment-section', 'active-appointments-section',
                'help-section', 'contact-section', 'about-section', 'feedback-section'
            ];
            
            // Tüm section'ları gizle
            allSections.forEach(sec => {
                if (sec === 'analyze') {
                    const analysisCard = document.querySelector('.analysis-card');
                    if (analysisCard) analysisCard.style.display = 'none';
                } else {
                    const el = document.getElementById(sec);
                    if (el) {
                        el.style.display = 'none';
                    }
                }
            });
            
            // Seçilen section'ı göster
            if (section === 'dashboard') {
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection) {
                    dashboardSection.style.display = 'block';
                    dashboardSection.style.visibility = 'visible';
                    dashboardSection.style.opacity = '1';
                    // Dashboard içindeki tüm child elementleri de göster
                    const allChildren = dashboardSection.querySelectorAll('*');
                    allChildren.forEach(child => {
                        if (child.style) {
                            if (child.style.display === 'none') {
                                child.style.display = '';
                            }
                            if (child.style.visibility === 'hidden') {
                                child.style.visibility = 'visible';
                            }
                        }
                    });
                }
            } else if (section === 'analyze') {
                document.querySelector('.analysis-card').style.display = 'block';
            } else if (section === 'history') {
                document.getElementById('history-card').style.display = 'block';
                if (window.loadHistory) window.loadHistory();
            } else if (section === 'favorites') {
                document.getElementById('favorites-card').style.display = 'block';
                if (window.loadFavorites) window.loadFavorites();
            } else if (section === 'stats') {
                document.getElementById('stats-card').style.display = 'block';
                if (window.loadStats) window.loadStats();
            } else if (section === 'appointments') {
                document.getElementById('appointments-card').style.display = 'block';
                // Randevuları yükle ve her 5 saniyede bir yenile (onaylanan randevular için)
                if (window.loadAppointments) {
                    window.loadAppointments();
                    // Otomatik yenileme (onaylanan randevular için)
                    if (window.appointmentsRefreshInterval) {
                        clearInterval(window.appointmentsRefreshInterval);
                    }
                    window.appointmentsRefreshInterval = setInterval(() => {
                        if (document.getElementById('appointments-card') && document.getElementById('appointments-card').style.display !== 'none') {
                            window.loadAppointments();
                        }
                    }, 5000); // Her 5 saniyede bir yenile
                }
            } else if (section === 'appointment') {
                document.getElementById('appointment-section').style.display = 'block';
                // Aktif randevular bölümünü de göster
                document.getElementById('active-appointments-section').style.display = 'block';
                // Aktif randevuları yükle
                if (window.loadActiveAppointments) {
                    window.loadActiveAppointments();
                }
                // Tarih input'unu bugünden itibaren ayarla
                const dateInput = document.getElementById('appointmentRequestDate');
                if (dateInput) {
                    const today = new Date();
                    today.setDate(today.getDate() + 1); // En az 1 gün sonra
                    dateInput.min = today.toISOString().split('T')[0];
                }
            } else if (section === 'help') {
                document.getElementById('help-section').style.display = 'block';
            } else if (section === 'contact') {
                document.getElementById('contact-section').style.display = 'block';
            } else if (section === 'about') {
                document.getElementById('about-section').style.display = 'block';
            } else if (section === 'feedback') {
                document.getElementById('feedback-section').style.display = 'block';
                // Yıldız rating'i sıfırla
                document.querySelectorAll('#feedback-section .feedback-star').forEach(star => {
                    star.classList.remove('active', 'fas');
                    star.classList.add('far');
                });
                const ratingInput = document.getElementById('feedbackSectionRating');
                if (ratingInput) ratingInput.value = '0';
            }
        };

        // Favorilere ekle/kaldır
        window.toggleFavorite = async function() {
            const analysisId = document.getElementById('current-analysis-id').value;
            if (!analysisId) {
                alert('Analiz ID bulunamadı');
                return;
            }

            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const favoriteBtn = document.getElementById('favorite-btn');
                const isFavorite = favoriteBtn.innerHTML.includes('fa-heart') && !favoriteBtn.innerHTML.includes('far');

                if (isFavorite) {
                    // Favoriden kaldır (favorite ID'yi bulmamız gerekiyor)
                    const favorites = await fetch(`${API_BASE_URL}/api/user/favorites`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json());
                    
                    const favorite = favorites.favorites?.find(f => f.analysis?.id === analysisId);
                    if (favorite) {
                        await fetch(`${API_BASE_URL}/api/user/favorites/${favorite.favoriteId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        favoriteBtn.innerHTML = '<i class="far fa-heart"></i> Favorilere Ekle';
                    }
                } else {
                    // Favorilere ekle
                    await fetch(`${API_BASE_URL}/api/user/favorites`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ analysisId: analysisId })
                    });
                    favoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Favorilerden Kaldır';
                    favoriteBtn.style.color = '#dc3545';
                }
            } catch (error) {
                console.error('Favori hatası:', error);
            }
        };

        // Paylaşım linki oluştur
        window.shareAnalysis = async function() {
            const analysisId = document.getElementById('current-analysis-id').value;
            if (!analysisId) {
                alert('Analiz ID bulunamadı');
                return;
            }

            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/share/analysis`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ analysisId: analysisId, expiresInDays: 30 })
                });

                if (response.ok) {
                    const data = await response.json();
                    const shareUrl = window.location.origin + window.location.pathname.replace('analyze.html', '') + 'shared.html?token=' + data.shareToken;
                    document.getElementById('share-link-input').value = shareUrl;
                    document.getElementById('shareModal').classList.add('show');
                }
            } catch (error) {
                console.error('Paylaşım hatası:', error);
            }
        };

        // Paylaşım linkini kopyala
        window.copyShareLink = function() {
            const input = document.getElementById('share-link-input');
            input.select();
            document.execCommand('copy');
            alert('Link kopyalandı!');
        };

        // Paylaşım modal'ını kapat
        window.closeShareModal = function() {
            document.getElementById('shareModal').classList.remove('show');
        };

        // Appointment Modal
        window.showAppointmentModal = function() {
            const modal = document.getElementById('appointmentModal');
            if (!modal) {
                console.error('Appointment modal bulunamadı');
                return;
            }
            modal.classList.add('show');
            
            // Minimum tarih bugünden itibaren
            const today = new Date();
            today.setDate(today.getDate() + 1); // En az 1 gün sonra
            const minDate = today.toISOString().split('T')[0];
            const dateInput = document.getElementById('appointmentDate');
            if (dateInput) {
                dateInput.min = minDate;
            }
        };

        window.closeAppointmentModal = function() {
            const modal = document.getElementById('appointmentModal');
            if (modal) {
                modal.classList.remove('show');
            }
            const form = document.getElementById('appointmentForm');
            if (form) {
                form.reset();
            }
        };

        // Appointment Request Form submit event listener (Yeni form - appointment-section)
        document.addEventListener('DOMContentLoaded', function() {
            const appointmentRequestForm = document.getElementById('appointmentRequestForm');
            if (appointmentRequestForm) {
                appointmentRequestForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const date = document.getElementById('appointmentRequestDate').value;
                    const time = document.getElementById('appointmentRequestTime').value;
                    const reason = document.getElementById('appointmentRequestReason').value;
                    const doctorType = document.getElementById('appointmentRequestDoctorType').value;
                    
                    if (!date || !time || !reason || !doctorType) {
                        showToast('Lütfen tüm zorunlu alanları doldurun.', 'warning');
                        return;
                    }
                    
                    try {
                        const user = window.auth?.currentUser || auth?.currentUser;
                        if (!user) {
                            showToast('Randevu talep etmek için giriş yapmalısınız.', 'warning');
                            return;
                        }
                        
                        const token = await user.getIdToken();
                        
                        // API URL'ini al (global veya local)
                        const apiUrl = window.API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                        
                        // Backend'e randevu kaydet
                        const response = await fetch(`${apiUrl}/api/appointments`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                date: date,
                                time: time,
                                reason: reason,
                                doctorType: doctorType
                                // status backend'de otomatik 'approved' olarak ayarlanıyor
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // Randevu otomatik onaylandı
                            if (data.status === 'approved') {
                                showToast('Randevunuz başarıyla oluşturuldu ve onaylandı! Görüntülü görüşmeye katılabilirsiniz.', 'success');
                            } else {
                                showToast('Randevu talebiniz başarıyla alındı! Onaylandığında size bildirim gönderilecektir.', 'success');
                            }
                            
                            // Formu temizle
                            appointmentRequestForm.reset();
                            
                            // Aktif randevuları yenile
                            if (window.loadActiveAppointments) {
                                setTimeout(() => {
                                    window.loadActiveAppointments();
                                }, 1000);
                            }
                            
                            // Randevu geçmişine yönlendir (opsiyonel)
                            // setTimeout(() => {
                            //     showSection('appointments', null);
                            //     if (window.loadAppointments) {
                            //         window.loadAppointments();
                            //     }
                            // }, 1500);
                        } else {
                            // Rate limiting veya diğer hatalar için
                            let errorMessage = 'Randevu talebi gönderilemedi.';
                            
                            if (response.status === 429) {
                                errorMessage = 'Çok fazla randevu talebi gönderdiniz. Lütfen bir saat sonra tekrar deneyin.';
                            } else {
                                try {
                                    const error = await response.json();
                                    errorMessage = error.error || error.message || 'Bilinmeyen hata';
                                } catch (jsonError) {
                                    // JSON parse hatası - backend HTML döndürmüş olabilir
                                    const text = await response.text();
                                    if (text.includes('<!doctype') || text.includes('<html')) {
                                        errorMessage = 'Sunucu hatası. Backend API\'nin çalıştığından emin olun.';
                                    } else {
                                        errorMessage = text || 'Bilinmeyen hata';
                                    }
                                }
                            }
                            
                            showToast(errorMessage, 'error');
                        }
                    } catch (error) {
                        console.error('Appointment request error:', error);
                        let errorMessage = 'Randevu talebi gönderilirken bir hata oluştu.';
                        
                        if (error.message && error.message.includes('JSON')) {
                            errorMessage = 'Sunucu yanıtı beklenmeyen formatta. Backend API\'nin çalıştığından emin olun.';
                        } else if (error.message && error.message.includes('Failed to fetch')) {
                            errorMessage = 'Backend API\'ye bağlanılamadı. Lütfen backend\'in çalıştığından emin olun.';
                        }
                        
                        showToast(errorMessage, 'error');
                    }
                });
            }
        });

        // Appointment form submit event listener (Eski modal form)
        document.addEventListener('DOMContentLoaded', function() {
            const appointmentForm = document.getElementById('appointmentForm');
            if (appointmentForm) {
                appointmentForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const date = document.getElementById('appointmentDate').value;
                    const time = document.getElementById('appointmentTime').value;
                    const reason = document.getElementById('appointmentReason').value;
                    const doctor = document.getElementById('appointmentDoctor').value;
                    
                    if (!date || !time || !reason) {
                        showToast('Lütfen tüm zorunlu alanları doldurun.', 'warning');
                        return;
                    }
                    
                    try {
                        const user = window.auth?.currentUser || auth?.currentUser;
                        if (!user) {
                            showToast('Randevu talep etmek için giriş yapmalısınız.', 'warning');
                            return;
                        }
                        
                        const token = await user.getIdToken();
                        
                        // API URL'ini al (global veya local)
                        const apiUrl = window.API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                        
                        // Backend'e randevu kaydet
                        const response = await fetch(`${apiUrl}/api/appointments`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                date: date,
                                time: time,
                                reason: reason,
                                doctorType: doctor || null
                                // status backend'de otomatik 'approved' olarak ayarlanıyor
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // Randevu otomatik onaylandı
                            if (data.status === 'approved') {
                                showToast('Randevunuz onaylandı! Görüntülü görüşmeye katılabilirsiniz.', 'success');
                            } else {
                                showToast('Randevu talebiniz alındı! Onaylandığında size bildirim gönderilecektir.', 'success');
                            }
                            closeAppointmentModal();
                            
                            // Randevu geçmişine yönlendir
                            if (data.appointmentId) {
                                setTimeout(() => {
                                    showSection('appointments', null);
                                    if (window.loadAppointments) {
                                        window.loadAppointments();
                                    }
                                }, 1000);
                            }
                        } else {
                            // Rate limiting veya diğer hatalar için
                            let errorMessage = 'Randevu talebi gönderilemedi.';
                            
                            if (response.status === 429) {
                                errorMessage = 'Çok fazla randevu talebi gönderdiniz. Lütfen bir saat sonra tekrar deneyin.';
                            } else {
                                try {
                                    const error = await response.json();
                                    errorMessage = error.error || error.message || 'Bilinmeyen hata';
                                } catch (jsonError) {
                                    // JSON parse hatası - backend HTML döndürmüş olabilir
                                    const text = await response.text();
                                    if (text.includes('<!doctype') || text.includes('<html')) {
                                        errorMessage = 'Sunucu hatası. Backend API\'nin çalıştığından emin olun.';
                                    } else {
                                        errorMessage = text || 'Bilinmeyen hata';
                                    }
                                }
                            }
                            
                            showToast(errorMessage, 'error');
                        }
                    } catch (error) {
                        console.error('Appointment error:', error);
                        let errorMessage = 'Randevu talebi gönderilirken bir hata oluştu.';
                        
                        if (error.message && error.message.includes('JSON')) {
                            errorMessage = 'Sunucu yanıtı beklenmeyen formatta. Backend API\'nin çalıştığından emin olun.';
                        }
                        
                        showToast(errorMessage, 'error');
                    }
                });
            }
        });

        // Feedback Modal
        window.showFeedbackModal = function() {
            document.getElementById('feedbackModal').classList.add('show');
            
            // Star rating event listeners
            const stars = document.querySelectorAll('.feedback-star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('feedbackRating').value = rating;
                    
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                            s.classList.remove('far');
                            s.classList.add('fas');
                        } else {
                            s.classList.remove('active');
                            s.classList.remove('fas');
                            s.classList.add('far');
                        }
                    });
                });
            });
        };

        window.closeFeedbackModal = function() {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackForm').reset();
            document.getElementById('feedbackRating').value = 0;
            document.querySelectorAll('.feedback-star').forEach(star => {
                star.classList.remove('active', 'fas');
                star.classList.add('far');
            });
        };

        // Feedback form submit
        document.getElementById('feedbackForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('feedbackType').value;
            const rating = document.getElementById('feedbackRating').value;
            const message = document.getElementById('feedbackMessage').value;
            
            if (!type || !message) {
                showToast('Lütfen tüm alanları doldurun.', 'warning');
                return;
            }
            
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) {
                    showToast('Geri bildirim göndermek için giriş yapmalısınız.', 'warning');
                    return;
                }
                
                const token = await user.getIdToken();
                
                // Firestore'a kaydet
                await addDoc(collection(db, 'feedback'), {
                    userId: user.uid,
                    type: type,
                    rating: parseInt(rating) || 0,
                    message: message,
                    createdAt: serverTimestamp(),
                    status: 'new'
                });
                
                // Backend API'ye gönder (opsiyonel)
                try {
                    await fetch(`${API_BASE_URL}/api/feedback`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type: type,
                            rating: parseInt(rating),
                            message: message
                        })
                    });
                } catch (apiError) {
                    console.warn('Feedback API error:', apiError);
                }
                
                showToast('Geri bildiriminiz için teşekkürler!', 'success');
                closeFeedbackModal();
            } catch (error) {
                console.error('Feedback error:', error);
                showToast('Geri bildirim gönderilirken bir hata oluştu.', 'error');
            }
        });

        // PDF Export
        window.exportToPDF = function() {
            // jsPDF kütüphanesi gerekli
            if (typeof window.jsPDF === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => generatePDF();
                document.head.appendChild(script);
            } else {
                generatePDF();
            }
        };

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Analiz Sonuçları Raporu', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            let y = 40;
            
            if (currentAnalysisData && currentAnalysisData.top_3) {
                doc.text('En Yüksek Tahminler:', 20, y);
                y += 10;
                currentAnalysisData.top_3.forEach((item, index) => {
                    const className = item.class_tr || item.class || item.className;
                    const confidence = ((item.confidence || item.probability || 0) * 100).toFixed(2);
                    doc.text(`${index + 1}. ${className}: %${confidence}`, 25, y);
                    y += 8;
                });
            }
            
            doc.text(`Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')}`, 20, y + 10);
            doc.text('Bu rapor sadece bilgilendirme amaçlıdır.', 20, y + 20);
            
            doc.save('analiz-raporu.pdf');
        };

        // Favorileri yükle
        window.loadFavorites = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/user/favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const favorites = data.favorites || [];
                    
                    if (favorites.length === 0) {
                        showEmptyState('favorites-content', 'heart', 'Henüz favori analiz yok', 'Beğendiğiniz analizleri favorilere ekleyerek burada görebilirsiniz.', null, null);
                        return;
                    }

                    const favoritesHtml = favorites.map(fav => {
                        const analysis = fav.analysis;
                        const date = new Date(analysis.createdAt * 1000).toLocaleDateString('tr-TR');
                        return `
                            <div class="result-item" style="margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <strong>${analysis.diseaseType}</strong> - ${analysis.topPrediction || 'N/A'}<br>
                                    <small>${date}</small>
                                </div>
                                ${analysis.imageUrl ? `<img src="${analysis.imageUrl}" style="max-width: 100px; border-radius: 5px; margin-left: 15px;" alt="Analiz görüntüsü">` : ''}
                                <button class="btn btn-sm btn-danger" onclick="removeFavorite('${fav.favoriteId}')" style="margin-left: 15px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('favorites-content').innerHTML = favoritesHtml;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                        console.error('Favoriler yükleme hatası:', errorData);
                        document.getElementById('favorites-content').innerHTML = `<p class="text-danger">Favoriler yüklenemedi: ${errorData.error || errorText}</p>`;
                    } catch (e) {
                        console.error('Favoriler yükleme hatası:', errorText);
                        document.getElementById('favorites-content').innerHTML = `<p class="text-danger">Favoriler yüklenemedi: ${errorText}</p>`;
                    }
                }
            } catch (error) {
                console.error('Favoriler yükleme hatası:', error);
                document.getElementById('favorites-content').innerHTML = '<p class="text-danger">Favoriler yüklenemedi.</p>';
            }
        };

        // Favoriden kaldır
        window.removeFavorite = async function(favoriteId) {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const response = await fetch(`${API_BASE_URL}/api/user/favorites/${favoriteId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    window.loadFavorites();
                }
            } catch (error) {
                console.error('Favori kaldırma hatası:', error);
            }
        };

        // Profil ayarlarını yükle

        // Gelişmiş filtreleme için loadHistory güncellemesi
        const originalLoadHistory = window.loadHistory;
        window.loadHistory = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const diseaseType = document.getElementById('history-filter-type')?.value || '';
                const filterDate = document.getElementById('history-filter-date')?.value || '';
                
                let url = `${API_BASE_URL}/api/user/analyses?limit=20`;
                if (diseaseType) url += `&diseaseType=${diseaseType}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    let analyses = data.analyses || [];
                    
                    // Tarih filtresi (frontend'de)
                    if (filterDate) {
                        const filterDateObj = new Date(filterDate);
                        analyses = analyses.filter(analysis => {
                            const analysisDate = new Date(analysis.createdAt * 1000);
                            return analysisDate.toDateString() === filterDateObj.toDateString();
                        });
                    }
                    
                    if (analyses.length === 0) {
                        showEmptyState('history-content', 'search', 'Filtre kriterlerine uygun analiz bulunamadı', 'Farklı filtreler deneyebilir veya yeni bir analiz yapabilirsiniz.', 'Filtreleri Temizle', 'document.getElementById(\'history-filter-type\').value = \'\'; document.getElementById(\'history-filter-date\').value = \'\'; window.loadHistory()');
                        return;
                    }

                    const historyHtml = analyses.map(analysis => {
                        const date = new Date(analysis.createdAt * 1000).toLocaleDateString('tr-TR');
                        return `
                            <div class="result-item" style="margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <strong>${analysis.diseaseType}</strong> - ${analysis.topPrediction || 'N/A'}<br>
                                    <small>${date}</small>
                                </div>
                                ${analysis.imageUrl ? `<img src="${analysis.imageUrl}" style="max-width: 100px; border-radius: 5px; margin-left: 15px;" alt="Analiz görüntüsü">` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('history-content').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Geçmiş yükleme hatası:', error);
                document.getElementById('history-content').innerHTML = '<p class="text-danger">Analiz geçmişi yüklenemedi.</p>';
            }
        };

        // Randevuları yükle
        window.loadAppointments = async function() {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) return;

                const token = await user.getIdToken();
                const statusFilter = document.getElementById('appointment-filter-status')?.value || '';
                
                let url = `${API_BASE_URL}/api/appointments`;
                if (statusFilter) {
                    url += `?status=${statusFilter}`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const appointments = data.appointments || [];
                    
                    const container = document.getElementById('appointments-content');
                    
                    if (appointments.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-calendar-times" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 15px;"></i>
                                <h3>Henüz randevu talebiniz yok</h3>
                                <p>Doktor ile görüntülü görüşme için yeni bir randevu talep edebilirsiniz.</p>
                                <button class="btn btn-primary" onclick="showAppointmentModal()">
                                    <i class="fas fa-plus"></i> Randevu Talep Et
                                </button>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div class="row">';
                    appointments.forEach(appointment => {
                        const statusColors = {
                            'pending': '#ffc107',
                            'approved': '#28a745',
                            'rejected': '#dc3545',
                            'completed': '#6c757d'
                        };
                        const statusTexts = {
                            'pending': 'Beklemede',
                            'approved': 'Onaylandı',
                            'rejected': 'Reddedildi',
                            'completed': 'Tamamlandı'
                        };
                        const status = appointment.status || 'pending';
                        const statusColor = statusColors[status] || '#6c757d';
                        const statusText = statusTexts[status] || status;

                        // Tarih formatla
                        const date = new Date(appointment.date);
                        const formattedDate = date.toLocaleDateString('tr-TR', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });

                        html += `
                            <div class="col-md-6" style="margin-bottom: 15px;">
                                <div class="card" style="border-left: 4px solid ${statusColor};">
                                    <div class="card-body">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                            <h5 style="margin: 0;">
                                                <i class="fas fa-calendar"></i> ${formattedDate}
                                            </h5>
                                            <span class="badge" style="background: ${statusColor}; color: white; padding: 5px 10px; border-radius: 15px;">
                                                ${statusText}
                                            </span>
                                        </div>
                                        <p style="margin: 5px 0; color: #666;">
                                            <i class="fas fa-clock"></i> ${appointment.time}
                                        </p>
                                        ${appointment.doctorType ? `
                                            <p style="margin: 5px 0; color: #666;">
                                                <i class="fas fa-user-md"></i> ${appointment.doctorType}
                                            </p>
                                        ` : ''}
                                        <p style="margin: 10px 0; color: #333;">
                                            <strong>Konu:</strong> ${appointment.reason || '-'}
                                        </p>
                                        ${status === 'approved' ? `
                                            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="btn btn-success btn-sm" onclick="joinAppointment('${appointment.id}')">
                                                    <i class="fas fa-video"></i> Görüntülü Görüşmeye Katıl
                                                </button>
                                                <button class="btn btn-info btn-sm" onclick="shareAppointmentLink('${appointment.id}')" title="Linki paylaş">
                                                    <i class="fas fa-share-alt"></i> Linki Paylaş
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    document.getElementById('appointments-content').innerHTML = 
                        '<p style="color: var(--danger);">Randevular yüklenirken bir hata oluştu.</p>';
                }
            } catch (error) {
                console.error('Appointments load error:', error);
                document.getElementById('appointments-content').innerHTML = 
                    '<p style="color: var(--danger);">Randevular yüklenirken bir hata oluştu.</p>';
            }
        };

        // Randevuya katıl (Jitsi Meet)
        window.joinAppointment = async function(appointmentId) {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) {
                    showToast('Giriş yapmalısınız.', 'warning');
                    return;
                }

                const token = await user.getIdToken();
                const apiUrl = window.API_BASE_URL || API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                const response = await fetch(`${apiUrl}/api/appointments/${appointmentId}/join`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Jitsi Meet sayfasına yönlendir
                    window.location.href = `templates/appointment.html?id=${appointmentId}`;
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Randevuya katılamadınız.', 'error');
                }
            } catch (error) {
                console.error('Join appointment error:', error);
                showToast('Randevuya katılırken bir hata oluştu.', 'error');
            }
        };

        // Randevu linkini paylaş (Jitsi URL'ini al ve göster)
        window.shareAppointmentLink = async function(appointmentId) {
            try {
                const user = (window.auth || auth)?.currentUser;
                if (!user) {
                    showToast('Giriş yapmalısınız.', 'warning');
                    return;
                }

                const token = await user.getIdToken();
                const apiUrl = window.API_BASE_URL || API_BASE_URL || (typeof config !== 'undefined' ? config.apiUrl : 'http://localhost:5001');
                const response = await fetch(`${apiUrl}/api/appointments/${appointmentId}/join`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const jitsiUrl = data.jitsiUrl;
                    
                    // URL'i kopyala
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(jitsiUrl);
                        showToast('✅ Jitsi Meet linki kopyalandı! Bu linki diğer cihazda (telefon, tablet) açabilirsiniz.', 'success');
                    } else {
                        // Fallback: Textarea kullan
                        const textarea = document.createElement('textarea');
                        textarea.value = jitsiUrl;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showToast('✅ Jitsi Meet linki kopyalandı! Bu linki diğer cihazda (telefon, tablet) açabilirsiniz.', 'success');
                    }
                    
                    // Modal ile linki göster
                    const modal = document.createElement('div');
                    modal.className = 'share-modal show';
                    modal.style.zIndex = '10000';
                    modal.innerHTML = `
                        <h3><i class="fas fa-share-alt"></i> Görüntülü Görüşme Linki</h3>
                        <p style="margin-bottom: 15px;">Bu linki diğer cihazda (telefon, tablet) açarak görüntülü görüşmeye katılabilirsiniz:</p>
                        <input type="text" class="share-link-input" id="jitsi-link-input" value="${jitsiUrl}" readonly style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ddd;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="copyJitsiLink()">
                                <i class="fas fa-copy"></i> Tekrar Kopyala
                            </button>
                            <button class="btn btn-success" onclick="window.open('${jitsiUrl}', '_blank')">
                                <i class="fas fa-external-link-alt"></i> Yeni Sekmede Aç
                            </button>
                            <button class="btn btn-secondary" onclick="this.closest('.share-modal').remove()">
                                Kapat
                            </button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Link alınamadı.', 'error');
                }
            } catch (error) {
                console.error('Share appointment link error:', error);
                showToast('Link alınırken bir hata oluştu.', 'error');
            }
        };

        // Jitsi linkini kopyala
        window.copyJitsiLink = function() {
            const input = document.getElementById('jitsi-link-input');
            if (input) {
                input.select();
                document.execCommand('copy');
                showToast('Link kopyalandı!', 'success');
            }
        };

        // Feedback Section - Yıldız seçimi için event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Event delegation ile yıldız seçimi
            document.addEventListener('click', function(e) {
                if (e.target && e.target.closest('#feedback-section') && e.target.classList.contains('feedback-star')) {
                    const star = e.target;
                    const rating = parseInt(star.getAttribute('data-rating'));
                    const ratingInput = document.getElementById('feedbackSectionRating');
                    
                    if (ratingInput) {
                        ratingInput.value = rating;
                        
                        // Tüm yıldızları güncelle
                        document.querySelectorAll('#feedback-section .feedback-star').forEach((s, index) => {
                            if (index < rating) {
                                s.classList.remove('far');
                                s.classList.add('fas', 'active');
                            } else {
                                s.classList.remove('fas', 'active');
                                s.classList.add('far');
                            }
                        });
                    }
                }
            });

            // Feedback Section Form Submit
            const feedbackSectionForm = document.getElementById('feedbackSectionForm');
            if (feedbackSectionForm) {
                feedbackSectionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const rating = document.getElementById('feedbackSectionRating')?.value || '0';
                    const message = document.getElementById('feedbackSectionMessage')?.value;
                    
                    if (!message || rating === '0') {
                        showToast('Lütfen mesajınızı yazın ve değerlendirme yapın.', 'warning');
                        return;
                    }
                    
                    try {
                        const user = (window.auth || auth)?.currentUser;
                        if (!user) {
                            showToast('Geri bildirim göndermek için giriş yapmalısınız.', 'warning');
                            return;
                        }
                        
                        const token = await user.getIdToken();
                        
                        // Firestore'a kaydet
                        await addDoc(collection(db, 'feedback'), {
                            userId: user.uid,
                            type: 'other',
                            rating: parseInt(rating) || 0,
                            message: message,
                            createdAt: serverTimestamp(),
                            status: 'new'
                        });
                        
                        // Backend API'ye gönder (opsiyonel)
                        try {
                            await fetch(`${API_BASE_URL}/api/feedback`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    type: 'other',
                                    rating: parseInt(rating),
                                    message: message
                                })
                            });
                        } catch (apiError) {
                            console.warn('Feedback API error:', apiError);
                        }
                        
                        showToast('Geri bildiriminiz için teşekkürler!', 'success');
                        document.getElementById('feedbackSectionForm').reset();
                        document.getElementById('feedbackSectionRating').value = '0';
                        document.querySelectorAll('#feedback-section .feedback-star').forEach(star => {
                            star.classList.remove('active', 'fas');
                            star.classList.add('far');
                        });
                        
                        const resultDiv = document.getElementById('feedback-section-result');
                        if (resultDiv) {
                            resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Geri bildiriminiz başarıyla gönderildi!</div>';
                            setTimeout(() => {
                                resultDiv.innerHTML = '';
                            }, 5000);
                        }
                    } catch (error) {
                        console.error('Feedback error:', error);
                        showToast('Geri bildirim gönderilirken bir hata oluştu.', 'error');
                    }
                });
            }
        });
    </script>
</body>
</html>
